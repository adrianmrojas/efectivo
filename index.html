<!DOCTYPE html>
<html lang="es" class="dark">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
<meta name="description" content="Efectivo ‚Äî Control total de finanzas personales para Paraguay">
<meta name="theme-color" content="#0f172a">
<title>üí∞ Efectivo</title>

<!-- Fuentes -->
<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;500;600;700;800&family=JetBrains+Mono:wght@400;500&display=swap" rel="stylesheet">

<!-- Chart.js -->
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.2/dist/chart.umd.min.js"></script>
<!-- Luxon (manejo de fechas) -->
<script src="https://cdn.jsdelivr.net/npm/luxon@3.4.4/build/global/luxon.min.js"></script>

<style>
/* ======================================================
   EFECTIVO ‚Äî Estilos
   ====================================================== */
@import url('https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;500;600;700;800&family=JetBrains+Mono:wght@400;500&display=swap');

:root {
  --bg:       #0f172a;
  --surface:  #1e293b;
  --border:   #334155;
  --text:     #f1f5f9;
  --muted:    #94a3b8;
  --dim:      #64748b;
  --green:    #10b981;
  --red:      #ef4444;
  --blue:     #3b82f6;
  --yellow:   #f59e0b;
  --purple:   #8b5cf6;
  --radius:   14px;
  --radius-sm:10px;
}

*{box-sizing:border-box;-webkit-tap-highlight-color:transparent;margin:0;padding:0}
html{scroll-behavior:smooth}

body{
  font-family:'Outfit',system-ui,sans-serif;
  background:var(--bg);color:var(--text);
  min-height:100vh;overflow-x:hidden;
  -webkit-font-smoothing:antialiased;
}

/* ‚îÄ‚îÄ Scrollbar ‚îÄ‚îÄ */
::-webkit-scrollbar{width:5px;height:5px}
::-webkit-scrollbar-track{background:transparent}
::-webkit-scrollbar-thumb{background:#334155;border-radius:3px}
::-webkit-scrollbar-thumb:hover{background:#475569}

/* ‚îÄ‚îÄ Tipograf√≠a ‚îÄ‚îÄ */
.mono{font-family:'JetBrains Mono',monospace}
.label{font-size:11px;font-weight:600;text-transform:uppercase;letter-spacing:.06em;color:var(--dim);margin-bottom:6px;display:block}
h1,h2,h3{font-weight:700}

/* ‚îÄ‚îÄ Cards ‚îÄ‚îÄ */
.card{
  background:var(--surface);border-radius:var(--radius);
  padding:16px;border:1px solid rgba(255,255,255,.04);
  box-shadow:0 1px 3px rgba(0,0,0,.3);
  transition:border-color .2s;
}

/* ‚îÄ‚îÄ Inputs ‚îÄ‚îÄ */
.input{
  background:var(--bg);border:1.5px solid var(--border);
  border-radius:var(--radius-sm);padding:10px 14px;
  color:var(--text);font-family:'Outfit',sans-serif;
  font-size:14px;width:100%;transition:border-color .2s,box-shadow .2s;outline:none;
}
.input:focus{border-color:var(--blue);box-shadow:0 0 0 3px rgba(59,130,246,.12)}
.input option{background:var(--surface);color:var(--text)}
textarea.input{resize:vertical}

/* ‚îÄ‚îÄ Botones ‚îÄ‚îÄ */
.btn{
  border:none;border-radius:var(--radius-sm);
  padding:10px 20px;font-family:'Outfit',sans-serif;
  font-size:14px;font-weight:600;cursor:pointer;transition:all .2s;
  display:inline-flex;align-items:center;justify-content:center;gap:6px;
}
.btn-primary{background:linear-gradient(135deg,#10b981,#059669);color:#fff}
.btn-primary:hover{transform:translateY(-1px);box-shadow:0 4px 12px rgba(16,185,129,.35)}
.btn-success{background:linear-gradient(135deg,#10b981,#059669);color:#fff}
.btn-success:hover{box-shadow:0 4px 12px rgba(16,185,129,.35)}
.btn-danger{background:linear-gradient(135deg,#ef4444,#dc2626);color:#fff}
.btn-danger:hover{box-shadow:0 4px 12px rgba(239,68,68,.35)}
.btn-ghost{
  background:var(--surface);color:var(--muted);
  border:1.5px solid var(--border);
}
.btn-ghost:hover{background:#273549;border-color:#475569;color:var(--text)}
.btn-ghost:disabled{opacity:.4;cursor:not-allowed;transform:none!important}
.btn-sm{padding:6px 14px;font-size:13px;border-radius:8px}
.btn-xs{padding:4px 10px;font-size:12px;border-radius:6px}

/* ‚îÄ‚îÄ Badges ‚îÄ‚îÄ */
.badge{
  display:inline-flex;align-items:center;
  font-size:11px;font-weight:600;padding:2px 8px;
  border-radius:99px;letter-spacing:.02em;
}
.badge-green{background:rgba(16,185,129,.15);color:#10b981}
.badge-red{background:rgba(239,68,68,.15);color:#ef4444}
.badge-blue{background:rgba(59,130,246,.15);color:#60a5fa}
.badge-gray{background:rgba(255,255,255,.07);color:var(--muted)}
.badge-yellow{background:rgba(245,158,11,.15);color:#f59e0b}

/* ‚îÄ‚îÄ Toggle ‚îÄ‚îÄ */
.toggle{position:relative;display:inline-flex;align-items:center;cursor:pointer}
.toggle input{opacity:0;width:0;height:0;position:absolute}
.toggle-track{
  width:42px;height:24px;background:var(--border);border-radius:99px;
  transition:background .2s;
}
.toggle input:checked ~ .toggle-track{background:var(--green)}
.toggle-thumb{
  position:absolute;top:3px;left:3px;
  width:18px;height:18px;background:#fff;border-radius:50%;
  transition:transform .2s;box-shadow:0 1px 3px rgba(0,0,0,.3);
}
.toggle input:checked ~ .toggle-thumb{transform:translateX(18px)}

/* ‚îÄ‚îÄ Tab bar ‚îÄ‚îÄ */
.tab-bar{
  display:flex;background:var(--bg);border-radius:var(--radius-sm);
  padding:3px;gap:2px;border:1.5px solid var(--border);
}
.tab-btn{
  flex:1;padding:7px 12px;border-radius:7px;border:none;
  font-family:'Outfit',sans-serif;font-size:13px;font-weight:600;
  cursor:pointer;transition:all .15s;background:transparent;color:var(--muted);
}
.tab-btn.active{background:var(--surface);color:var(--text);box-shadow:0 1px 3px rgba(0,0,0,.3)}

/* ‚îÄ‚îÄ Progress ‚îÄ‚îÄ */
.progress-track{
  height:8px;background:rgba(255,255,255,.07);
  border-radius:99px;overflow:hidden;
}
.progress-fill{height:100%;border-radius:99px;background:var(--blue);transition:width .8s cubic-bezier(.34,1.56,.64,1)}
.progress-fill.warning{background:var(--yellow)}
.progress-fill.danger{background:var(--red)}

/* ‚îÄ‚îÄ Layout general ‚îÄ‚îÄ */
#app-header{
  background:rgba(15,23,42,.92);backdrop-filter:blur(12px);
  border-bottom:1px solid var(--border);
  position:sticky;top:0;z-index:50;padding:0 16px;
  display:flex;align-items:center;height:52px;gap:12px;
}
#bottom-nav{
  background:rgba(15,23,42,.97);backdrop-filter:blur(12px);
  border-top:1px solid var(--border);
  position:fixed;bottom:0;left:0;right:0;z-index:50;
  display:flex;padding:4px 8px 8px;safe-area-inset-bottom:env(safe-area-inset-bottom);
}
#main-content{
  padding-bottom:80px;min-height:calc(100vh - 52px);
}

/* ‚îÄ‚îÄ Nav items ‚îÄ‚îÄ */
.nav-item{
  display:flex;flex-direction:column;align-items:center;gap:2px;
  padding:6px 4px;cursor:pointer;color:var(--dim);
  font-size:10px;font-weight:500;transition:all .15s;
  border-radius:10px;flex:1;border:none;background:none;
  font-family:'Outfit',sans-serif;
}
.nav-item:hover{color:var(--muted);background:rgba(255,255,255,.04)}
.nav-item.active{color:var(--green);background:rgba(16,185,129,.1)}
.nav-icon{font-size:18px;line-height:1}

/* ‚îÄ‚îÄ Sidebar desktop ‚îÄ‚îÄ */
#sidebar{
  display:none;position:fixed;left:0;top:0;bottom:0;width:210px;
  background:rgba(15,23,42,.99);border-right:1px solid var(--border);
  flex-direction:column;padding:16px 10px;z-index:60;overflow-y:auto;
}
#sidebar-overlay{
  display:none;position:fixed;inset:0;background:rgba(0,0,0,.6);
  z-index:55;backdrop-filter:blur(2px);
}
#sidebar-overlay.active{display:block}
.sidebar-nav-item{
  display:flex;align-items:center;gap:10px;padding:9px 12px;
  border-radius:10px;cursor:pointer;color:var(--dim);font-size:13.5px;
  font-weight:500;transition:all .15s;border:none;background:none;
  width:100%;text-align:left;font-family:'Outfit',sans-serif;
}
.sidebar-nav-item:hover{color:var(--muted);background:var(--surface)}
.sidebar-nav-item.active{color:var(--green);background:rgba(16,185,129,.1)}
.sidebar-logo{
  font-family:'JetBrains Mono',monospace;font-weight:700;
  font-size:1.1rem;color:var(--green);letter-spacing:.05em;
  padding:8px 12px 16px;border-bottom:1px solid var(--border);margin-bottom:8px;
}

@media(min-width:768px){
  #bottom-nav{display:none}
  #fab-btn,#fab-menu{display:none!important}
  #sidebar{display:flex}
  #main-content,#app-header{margin-left:210px}
  #hamburger{display:none!important}
}

/* ‚îÄ‚îÄ FAB ‚îÄ‚îÄ */
#fab-btn{
  position:fixed;bottom:74px;right:16px;
  width:54px;height:54px;
  background:linear-gradient(135deg,#10b981,#059669);
  border-radius:50%;border:none;color:#fff;font-size:28px;
  cursor:pointer;box-shadow:0 4px 20px rgba(16,185,129,.5);
  transition:all .3s;z-index:100;
  display:flex;align-items:center;justify-content:center;
}
#fab-btn.open{transform:rotate(45deg)}
#fab-menu{
  position:fixed;bottom:140px;right:16px;
  display:flex;flex-direction:column;gap:8px;z-index:100;
  pointer-events:none;opacity:0;transform:translateY(10px);
  transition:all .2s;
}
#fab-menu.open{pointer-events:auto;opacity:1;transform:translateY(0)}
.fab-option{
  display:flex;align-items:center;gap:10px;background:var(--surface);
  border:1.5px solid var(--border);border-radius:12px;padding:10px 16px;
  cursor:pointer;color:var(--text);font-size:14px;font-weight:500;
  font-family:'Outfit',sans-serif;transition:all .2s;white-space:nowrap;
  box-shadow:0 4px 12px rgba(0,0,0,.3);
}
.fab-option:hover{background:#273549;transform:translateX(-4px)}

/* ‚îÄ‚îÄ Modal ‚îÄ‚îÄ */
#modal-overlay{
  position:fixed;inset:0;background:rgba(0,0,0,.75);
  backdrop-filter:blur(4px);z-index:200;
  display:flex;align-items:flex-end;justify-content:center;
}
@media(min-width:640px){#modal-overlay{align-items:center}}
#modal-content{
  background:var(--surface);border-radius:24px 24px 0 0;
  width:100%;max-width:540px;max-height:92vh;overflow-y:auto;
  transform:translateY(100%);transition:transform .3s cubic-bezier(.34,1.56,.64,1);
}
#modal-content.modal-show{transform:translateY(0)}
@media(min-width:640px){
  #modal-content{
    border-radius:24px;
    transform:scale(.9) translateY(20px);opacity:0;
    transition:all .25s cubic-bezier(.34,1.56,.64,1);
  }
  #modal-content.modal-show{transform:scale(1) translateY(0);opacity:1}
}
.modal-header{
  display:flex;align-items:center;justify-content:space-between;
  padding:20px 20px 16px;border-bottom:1px solid var(--border);
}
.modal-body{padding:20px}
.modal-footer{
  display:flex;align-items:center;gap:10px;
  padding:16px 20px 20px;border-top:1px solid var(--border);
}
.modal-close{
  background:none;border:none;cursor:pointer;
  color:var(--muted);font-size:20px;padding:4px;
  border-radius:6px;transition:color .15s;line-height:1;
}
.modal-close:hover{color:var(--text)}

/* ‚îÄ‚îÄ Transacciones ‚îÄ‚îÄ */
.tx-item{
  display:flex;align-items:center;gap:12px;
  padding:12px 16px;cursor:pointer;transition:background .15s;
  border-bottom:1px solid rgba(255,255,255,.04);
}
.tx-item:last-child{border-bottom:none}
.tx-item:hover{background:rgba(255,255,255,.03)}
.tx-icon{
  width:36px;height:36px;border-radius:10px;
  display:flex;align-items:center;justify-content:center;
  font-size:1.1rem;flex-shrink:0;
}

/* ‚îÄ‚îÄ Grid helpers ‚îÄ‚îÄ */
.stats-grid{display:grid;grid-template-columns:repeat(2,1fr);gap:12px}
.two-col{display:grid;grid-template-columns:1fr 1fr;gap:12px}
.three-col{display:grid;grid-template-columns:repeat(3,1fr);gap:10px}
@media(min-width:640px){.stats-grid{grid-template-columns:repeat(4,1fr)}}
@media(max-width:640px){.two-col{grid-template-columns:1fr}}

/* ‚îÄ‚îÄ Stat cards ‚îÄ‚îÄ */
.stat-card{
  background:rgba(255,255,255,.03);border:1px solid rgba(255,255,255,.06);
  border-radius:12px;padding:12px 14px;
}

/* ‚îÄ‚îÄ Proyecci√≥n ‚îÄ‚îÄ */
.proj-row{
  display:grid;grid-template-columns:100px 1fr auto auto;gap:8px;
  align-items:center;padding:8px 0;
  border-bottom:1px solid rgba(255,255,255,.04);font-size:13px;
}
.proj-row:last-child{border-bottom:none}
.proj-date{color:var(--dim);font-size:12px}
.proj-event{color:var(--muted);overflow:hidden;text-overflow:ellipsis;white-space:nowrap;display:flex;align-items:center;gap:6px}
.proj-amount{font-family:'JetBrains Mono',monospace;font-size:12px;font-weight:600;white-space:nowrap;text-align:right}
.proj-balance{font-family:'JetBrains Mono',monospace;font-size:12px;font-weight:700;white-space:nowrap;text-align:right;min-width:90px}

/* ‚îÄ‚îÄ Metas ‚îÄ‚îÄ */
.goal-card{
  background:var(--surface);border:1px solid rgba(255,255,255,.06);
  border-radius:16px;padding:20px;cursor:pointer;transition:border-color .2s;
}
.goal-card:hover{border-color:rgba(255,255,255,.15)}
.goal-card.primary{border-color:rgba(59,130,246,.3);box-shadow:0 0 0 1px rgba(59,130,246,.1)}

/* ‚îÄ‚îÄ Color swatches ‚îÄ‚îÄ */
.color-swatch{
  width:22px;height:22px;border-radius:50%;cursor:pointer;
  transition:transform .15s;border:2px solid transparent;
}
.color-swatch:hover{transform:scale(1.2)}
.color-swatch.selected{border-color:#fff;transform:scale(1.2)}

/* ‚îÄ‚îÄ Misc ‚îÄ‚îÄ */
.empty-state{
  display:flex;flex-direction:column;align-items:center;justify-content:center;
  padding:40px 20px;gap:8px;
}
.empty-state-icon{font-size:2.5rem}
.empty-state-title{font-weight:600;font-size:1rem}
.empty-state-text{color:var(--dim);font-size:0.85rem;text-align:center}

.highlight-banner{
  background:rgba(59,130,246,.08);border:1px solid rgba(59,130,246,.2);
  border-radius:12px;padding:16px;
}

.pagination{display:flex;align-items:center;justify-content:center;gap:4px;margin-top:16px}
.page-btn{
  width:32px;height:32px;border-radius:8px;border:1.5px solid var(--border);
  background:var(--surface);color:var(--muted);font-family:'Outfit',sans-serif;
  font-size:13px;cursor:pointer;transition:all .15s;
  display:flex;align-items:center;justify-content:center;
}
.page-btn:hover{border-color:#475569;color:var(--text)}
.page-btn.active{background:var(--blue);border-color:var(--blue);color:#fff}
.page-btn:disabled{opacity:.3;cursor:not-allowed}

/* ‚îÄ‚îÄ Toast ‚îÄ‚îÄ */
#toast{
  position:fixed;bottom:80px;left:50%;transform:translateX(-50%) translateY(20px);
  background:var(--surface);color:var(--text);border:1px solid var(--border);
  padding:10px 20px;border-radius:12px;font-size:14px;font-weight:500;
  z-index:9999;transition:all .3s;opacity:0;pointer-events:none;
  box-shadow:0 4px 20px rgba(0,0,0,.4);white-space:nowrap;
}
@media(min-width:768px){#toast{bottom:24px}}

/* ‚îÄ‚îÄ Tema claro ‚îÄ‚îÄ */
html:not(.dark) body{background:#f8fafc;color:#0f172a}
html:not(.dark) .card{background:#fff;border-color:#e2e8f0;box-shadow:0 1px 3px rgba(0,0,0,.06);color:#0f172a}
html:not(.dark) .stat-card{background:rgba(0,0,0,.02);border-color:#e2e8f0}
html:not(.dark) .input{background:#f8fafc;border-color:#e2e8f0;color:#0f172a}
html:not(.dark) .input option{background:#fff;color:#0f172a}
html:not(.dark) .btn-ghost{background:#f1f5f9;border-color:#e2e8f0;color:#475569}
html:not(.dark) .btn-ghost:hover{background:#e2e8f0;color:#0f172a}
html:not(.dark) #modal-content{background:#fff}
html:not(.dark) .fab-option{background:#fff;border-color:#e2e8f0;color:#0f172a}
html:not(.dark) .nav-item:hover{background:#f1f5f9}
html:not(.dark) #app-header{background:rgba(248,250,252,.92);border-color:#e2e8f0}
html:not(.dark) #bottom-nav{background:rgba(248,250,252,.97);border-color:#e2e8f0}
html:not(.dark) #sidebar{background:rgba(248,250,252,.99);border-color:#e2e8f0}
html:not(.dark) .sidebar-nav-item:hover{background:#f1f5f9;color:#0f172a}
html:not(.dark) .tx-item:hover{background:rgba(0,0,0,.02)}
html:not(.dark) .goal-card{background:#fff;border-color:#e2e8f0}
html:not(.dark) .tab-bar{background:#f8fafc;border-color:#e2e8f0}
html:not(.dark) .tab-btn.active{background:#fff;color:#0f172a}
html:not(.dark) .highlight-banner{background:rgba(59,130,246,.05);border-color:rgba(59,130,246,.2)}
html:not(.dark) #toast{background:#fff;border-color:#e2e8f0;color:#0f172a}
html:not(.dark) ::-webkit-scrollbar-thumb{background:#cbd5e1}
html:not(.dark) #modal-overlay{background:rgba(0,0,0,.5)}

/* ‚îÄ‚îÄ Animations ‚îÄ‚îÄ */
@keyframes slideIn{from{opacity:0;transform:translateY(8px)}to{opacity:1;transform:translateY(0)}}
.app-section > *{animation:slideIn .2s ease}
@keyframes spin{to{transform:rotate(360deg)}}
.spinner{width:36px;height:36px;border:3px solid rgba(16,185,129,.2);border-top-color:var(--green);border-radius:50%;animation:spin .7s linear infinite}

/* ‚îÄ‚îÄ Loading ‚îÄ‚îÄ */
#loading{
  position:fixed;inset:0;background:var(--bg);
  display:flex;flex-direction:column;align-items:center;justify-content:center;
  gap:16px;z-index:9999;
}
#loading-logo{font-family:'JetBrains Mono',monospace;font-size:2rem;font-weight:700;color:var(--green);letter-spacing:.05em}

/* ‚îÄ‚îÄ Chart container ‚îÄ‚îÄ */
.chart-container{position:relative;width:100%}
</style>
</head>
<body>

<!-- Loading splash -->
<div id="loading">
  <div style="font-size:3rem">üí∞</div>
  <div id="loading-logo">EFECTIVO</div>
  <div class="spinner"></div>
</div>

<!-- App shell -->
<div id="app" style="display:none">

  <!-- Sidebar (desktop) -->
  <div id="sidebar-overlay"></div>
  <aside id="sidebar">
    <div class="sidebar-logo">üí∞ Efectivo</div>
    <nav id="sidebar-nav"></nav>
  </aside>

  <!-- Header -->
  <header id="app-header">
    <button id="hamburger" onclick="openSidebar()" style="background:none;border:none;cursor:pointer;color:var(--muted);font-size:20px;padding:4px;flex-shrink:0">‚ò∞</button>
    <div id="topbar-title" style="font-weight:700;font-size:1rem;flex:1">Dashboard</div>
  </header>

  <!-- Main content -->
  <main id="main-content">
    <div id="section-dashboard"  class="app-section"></div>
    <div id="section-transactions" class="app-section" style="display:none"></div>
    <div id="section-templates"  class="app-section" style="display:none"></div>
    <div id="section-categories" class="app-section" style="display:none"></div>
    <div id="section-goals"      class="app-section" style="display:none"></div>
    <div id="section-reports"    class="app-section" style="display:none"></div>
    <div id="section-settings"   class="app-section" style="display:none"></div>
  </main>

  <!-- Bottom nav (mobile) -->
  <nav id="bottom-nav">
    <nav id="mobile-nav" style="display:flex;width:100%"></nav>
  </nav>

</div><!-- /#app -->

<!-- FAB (mobile) -->
<button id="fab-btn">+</button>
<div id="fab-menu">
  <div class="fab-option" id="fab-income">üíö Agregar ingreso</div>
  <div class="fab-option" id="fab-expense">‚ù§Ô∏è Agregar gasto</div>
</div>

<!-- Modal -->
<div id="modal-overlay" style="display:none">
  <div id="modal-content"></div>
</div>

<!-- Toast -->
<div id="toast"></div>

<script>
/* ======================================================
   EFECTIVO ‚Äî Utils
   ====================================================== */
const Utils = (() => {
  function uuid() {
    return 'xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx'.replace(/[xy]/g, c => {
      const r = Math.random() * 16 | 0;
      return (c === 'x' ? r : (r & 0x3 | 0x8)).toString(16);
    });
  }

  function fmtPYG(amount, showSign = false) {
    const abs = Math.abs(Math.round(Number(amount) || 0));
    const formatted = abs.toString().replace(/\B(?=(\d{3})+(?!\d))/g, '.');
    const sign = showSign ? (amount >= 0 ? '+' : '-') : (amount < 0 ? '-' : '');
    return `${sign}‚Ç≤ ${formatted}`;
  }

  function parsePYG(str) {
    return parseInt(String(str).replace(/[^\d-]/g, ''), 10) || 0;
  }

  function today() { return fmtDate(new Date()); }

  function fmtDate(d) {
    if (typeof d === 'string') d = parseDate(d);
    const y = d.getFullYear();
    const m = String(d.getMonth() + 1).padStart(2, '0');
    const day = String(d.getDate()).padStart(2, '0');
    return `${y}-${m}-${day}`;
  }

  function parseDate(str) {
    const [y, m, d] = String(str).split('-').map(Number);
    return new Date(y, m - 1, d);
  }

  function fmtDateHuman(str) {
    if (!str) return '';
    const d = parseDate(str);
    const months = ['Ene','Feb','Mar','Abr','May','Jun','Jul','Ago','Sep','Oct','Nov','Dic'];
    return `${d.getDate()} ${months[d.getMonth()]} ${d.getFullYear()}`;
  }

  function fmtDateFull(str) {
    if (!str) return '';
    const d = parseDate(str);
    const months = ['enero','febrero','marzo','abril','mayo','junio','julio','agosto','septiembre','octubre','noviembre','diciembre'];
    const days = ['Domingo','Lunes','Martes','Mi√©rcoles','Jueves','Viernes','S√°bado'];
    return `${days[d.getDay()]}, ${d.getDate()} de ${months[d.getMonth()]} ${d.getFullYear()}`;
  }

  function addDays(str, n) {
    const d = parseDate(str);
    d.setDate(d.getDate() + n);
    return fmtDate(d);
  }

  function addMonths(str, n) {
    const d = parseDate(str);
    d.setMonth(d.getMonth() + n);
    return fmtDate(d);
  }

  function diffDays(a, b) {
    return Math.round((parseDate(b) - parseDate(a)) / 86400000);
  }

  function endOfMonth(str) {
    const d = parseDate(str);
    return fmtDate(new Date(d.getFullYear(), d.getMonth() + 1, 0));
  }

  function monthName(str) {
    const months = ['Enero','Febrero','Marzo','Abril','Mayo','Junio','Julio','Agosto','Septiembre','Octubre','Noviembre','Diciembre'];
    const d = parseDate(str);
    return `${months[d.getMonth()]} ${d.getFullYear()}`;
  }

  const PREFIX = 'efectivo_';
  function save(key, data) {
    try { localStorage.setItem(PREFIX + key, JSON.stringify(data)); } catch(e) { console.error(e); }
  }
  function load(key, fallback = null) {
    try { const i = localStorage.getItem(PREFIX + key); return i ? JSON.parse(i) : fallback; } catch(e) { return fallback; }
  }
  function remove(key) { localStorage.removeItem(PREFIX + key); }

  function exportAll() {
    const keys = ['transactions','templates','categories','goals','config'];
    const data = {}; keys.forEach(k => { data[k] = load(k); });
    data._version = '1.0.0'; data._exportedAt = new Date().toISOString();
    return data;
  }
  function importAll(data) {
    const keys = ['transactions','templates','categories','goals','config'];
    keys.forEach(k => { if (data[k] !== undefined) save(k, data[k]); });
  }
  function clearAll() {
    ['transactions','templates','categories','goals','config'].forEach(k => remove(k));
  }

  let toastTimeout;
  function toast(msg, type = 'success') {
    const el = document.getElementById('toast');
    if (!el) return;
    el.textContent = msg;
    el.style.background = type === 'error' ? '#ef4444' : type === 'info' ? '#3b82f6' : '';
    el.style.color = (type === 'error' || type === 'info') ? '#fff' : '';
    el.style.opacity = '1';
    el.style.transform = 'translateX(-50%) translateY(0)';
    clearTimeout(toastTimeout);
    toastTimeout = setTimeout(() => {
      el.style.opacity = '0';
      el.style.transform = 'translateX(-50%) translateY(20px)';
    }, 3000);
  }

  function downloadJSON(data, filename) {
    const blob = new Blob([JSON.stringify(data, null, 2)], {type:'application/json'});
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url; a.download = filename; a.click();
    URL.revokeObjectURL(url);
  }

  function downloadCSV(rows, filename) {
    const csv = rows.map(r => r.map(c => `"${String(c).replace(/"/g,'""')}"`).join(',')).join('\n');
    const blob = new Blob(['\ufeff' + csv], {type:'text/csv;charset=utf-8'});
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url; a.download = filename; a.click();
    URL.revokeObjectURL(url);
  }

  function clamp(val, min, max) { return Math.min(Math.max(val, min), max); }
  function pct(val, total) { if (!total) return 0; return Math.round((val / total) * 100); }
  function groupBy(arr, fn) {
    return arr.reduce((acc, item) => { const key = fn(item); (acc[key] = acc[key] || []).push(item); return acc; }, {});
  }
  function sumBy(arr, fn) { return arr.reduce((s, x) => s + (fn(x) || 0), 0); }

  return { uuid, fmtPYG, parsePYG, today, fmtDate, parseDate, fmtDateHuman, fmtDateFull,
           addDays, addMonths, diffDays, endOfMonth, monthName,
           save, load, remove, exportAll, importAll, clearAll,
           toast, downloadJSON, downloadCSV, clamp, pct, groupBy, sumBy };
})();
</script>

<script>
/* ======================================================
   EFECTIVO ‚Äî Motor de Recurrencias
   ====================================================== */
const Recurrence = (() => {
  function fmt(d) {
    return `${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,'0')}-${String(d.getDate()).padStart(2,'0')}`;
  }
  function parse(str) {
    const [y,m,d] = str.split('-').map(Number);
    return new Date(y, m-1, d);
  }
  function firstWeekdayOfMonth(year, month, dow) {
    const d = new Date(year, month, 1);
    const diff = (dow - d.getDay() + 7) % 7;
    return new Date(year, month, 1 + diff);
  }
  function lastDayOfMonth(year, month) { return new Date(year, month+1, 0); }
  function nthWeekdayOfMonth(year, month, dow, n) {
    const first = firstWeekdayOfMonth(year, month, dow);
    return new Date(year, month, first.getDate() + (n-1)*7);
  }
  function lastWeekdayOfMonth(year, month, dow) {
    const last = lastDayOfMonth(year, month);
    const diff = (last.getDay() - dow + 7) % 7;
    return new Date(year, month, last.getDate() - diff);
  }

  function getOccurrencesInRange(template, rangeStart, rangeEnd) {
    const occurrences = [];
    const rec = template.recurrence;
    const rsDate = parse(rangeStart);
    const reDate = parse(rangeEnd);
    const tStart = parse(template.startDate || rangeStart);
    const tEnd = template.endDate ? parse(template.endDate) : null;
    const effectiveEnd = tEnd && tEnd < reDate ? tEnd : reDate;
    if (tStart > effectiveEnd) return [];

    function add(d) {
      if (d >= rsDate && d <= effectiveEnd) occurrences.push(fmt(d));
    }

    switch(rec.type) {
      case 'daily': {
        let cur = new Date(tStart);
        while (cur <= effectiveEnd) { add(new Date(cur)); cur.setDate(cur.getDate()+1); }
        break;
      }
      case 'every_n_days': {
        const n = rec.n || 2;
        let cur = new Date(tStart);
        while (cur <= effectiveEnd) { add(new Date(cur)); cur.setDate(cur.getDate()+n); }
        break;
      }
      case 'weekly': {
        let cur = new Date(tStart);
        while (cur <= effectiveEnd) { add(new Date(cur)); cur.setDate(cur.getDate()+7); }
        break;
      }
      case 'biweekly': {
        let cur = new Date(tStart);
        while (cur <= effectiveEnd) { add(new Date(cur)); cur.setDate(cur.getDate()+14); }
        break;
      }
      case 'monthly': {
        const targetDay = tStart.getDate();
        let cur = new Date(tStart.getFullYear(), tStart.getMonth(), 1);
        while (cur <= effectiveEnd) {
          const lastDay = lastDayOfMonth(cur.getFullYear(), cur.getMonth()).getDate();
          add(new Date(cur.getFullYear(), cur.getMonth(), Math.min(targetDay, lastDay)));
          cur.setMonth(cur.getMonth()+1);
        }
        break;
      }
      case 'annual': {
        let cur = new Date(tStart);
        while (cur <= effectiveEnd) { add(new Date(cur)); cur.setFullYear(cur.getFullYear()+1); }
        break;
      }
      case 'special': {
        let year = tStart.getFullYear(), month = tStart.getMonth();
        while (new Date(year, month, 1) <= effectiveEnd) {
          const dates = [];
          switch(rec.special) {
            case 'first_monday':    dates.push(firstWeekdayOfMonth(year,month,1)); break;
            case 'first_tuesday':   dates.push(firstWeekdayOfMonth(year,month,2)); break;
            case 'first_wednesday': dates.push(firstWeekdayOfMonth(year,month,3)); break;
            case 'first_thursday':  dates.push(firstWeekdayOfMonth(year,month,4)); break;
            case 'first_friday':    dates.push(firstWeekdayOfMonth(year,month,5)); break;
            case 'first_saturday':  dates.push(firstWeekdayOfMonth(year,month,6)); break;
            case 'last_day':        dates.push(lastDayOfMonth(year,month)); break;
            case 'last_friday':     dates.push(lastWeekdayOfMonth(year,month,5)); break;
            case 'last_monday':     dates.push(lastWeekdayOfMonth(year,month,1)); break;
            case 'day_15_and_last': dates.push(new Date(year,month,15)); dates.push(lastDayOfMonth(year,month)); break;
            case 'day_1_and_15':    dates.push(new Date(year,month,1)); dates.push(new Date(year,month,15)); break;
            case 'second_friday':   dates.push(nthWeekdayOfMonth(year,month,5,2)); break;
            case 'third_friday':    dates.push(nthWeekdayOfMonth(year,month,5,3)); break;
          }
          dates.forEach(d => { if (d >= tStart) add(d); });
          month++; if (month > 11) { month = 0; year++; }
        }
        break;
      }
    }
    return [...new Set(occurrences)].sort();
  }

  const SPECIAL_LABELS = {
    first_monday:'Primer lunes del mes', first_tuesday:'Primer martes del mes',
    first_wednesday:'Primer mi√©rcoles del mes', first_thursday:'Primer jueves del mes',
    first_friday:'Primer viernes del mes', first_saturday:'Primer s√°bado del mes',
    last_day:'√öltimo d√≠a del mes', last_friday:'√öltimo viernes del mes',
    last_monday:'√öltimo lunes del mes', day_15_and_last:'D√≠a 15 y √∫ltimo del mes',
    day_1_and_15:'D√≠a 1 y 15 del mes', second_friday:'Segundo viernes del mes',
    third_friday:'Tercer viernes del mes',
  };

  function getLabel(rec) {
    if (!rec) return '';
    switch(rec.type) {
      case 'daily': return 'Diario';
      case 'every_n_days': return `Cada ${rec.n} d√≠as`;
      case 'weekly': return 'Semanal';
      case 'biweekly': return 'Quincenal';
      case 'monthly': return 'Mensual';
      case 'annual': return 'Anual';
      case 'special': return SPECIAL_LABELS[rec.special] || rec.special;
      default: return '';
    }
  }

  const SPECIAL_OPTIONS = Object.entries(SPECIAL_LABELS).map(([v,l]) => ({value:v, label:l}));
  return { getOccurrencesInRange, getLabel, SPECIAL_OPTIONS, SPECIAL_LABELS };
})();
</script>

<script>
/* ======================================================
   EFECTIVO ‚Äî App Principal
   ====================================================== */

// ‚îÄ‚îÄ Estado global ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
let state = {
  transactions: [],
  templates: [],
  categories: [],
  goals: [],
  config: { theme:'dark', paymentDay:1, primaryGoalId:null, version:'1.0.0' }
};
let charts = {};
let currentSection = 'dashboard';
let txPage = 1;
const TX_PAGE_SIZE = 15;
let txFilters = { type:'', categoryId:'', search:'', month:'' };
let fabOpen = false;

// ‚îÄ‚îÄ Categor√≠as por defecto ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
const DEFAULT_CATEGORIES = [
  { id:'cat_salario',       name:'Salario',          type:'income',  emoji:'üíº', color:'#10b981', subcategories:[] },
  { id:'cat_freelance',     name:'Freelance',        type:'income',  emoji:'üíª', color:'#3b82f6', subcategories:[] },
  { id:'cat_inversiones',   name:'Inversiones',      type:'income',  emoji:'üìà', color:'#8b5cf6', subcategories:[] },
  { id:'cat_extra',         name:'Ingresos Extra',   type:'income',  emoji:'üí∞', color:'#f59e0b', subcategories:[] },
  { id:'cat_alimentos',     name:'Alimentaci√≥n',     type:'expense', emoji:'üõí', color:'#f59e0b',
    subcategories:[{id:'sub_super',name:'Supermercado'},{id:'sub_rest',name:'Restaurantes'},{id:'sub_cafe',name:'Caf√©/Snacks'}] },
  { id:'cat_transporte',    name:'Transporte',       type:'expense', emoji:'üöå', color:'#06b6d4',
    subcategories:[{id:'sub_bus',name:'Bus/Taxi'},{id:'sub_comb',name:'Combustible'},{id:'sub_mant',name:'Mantenimiento'}] },
  { id:'cat_alquiler',      name:'Alquiler/Vivienda',type:'expense', emoji:'üè†', color:'#ef4444',
    subcategories:[{id:'sub_alq',name:'Alquiler'},{id:'sub_serv',name:'Servicios'}] },
  { id:'cat_salud',         name:'Salud',            type:'expense', emoji:'üè•', color:'#ec4899',
    subcategories:[{id:'sub_med',name:'Medicamentos'},{id:'sub_cons',name:'Consultas'}] },
  { id:'cat_servicios',     name:'Servicios',        type:'expense', emoji:'‚ö°', color:'#a78bfa',
    subcategories:[{id:'sub_luz',name:'Luz/Agua'},{id:'sub_inter',name:'Internet'},{id:'sub_cel',name:'Celular'}] },
  { id:'cat_deudas',        name:'Deudas/Pr√©stamos', type:'expense', emoji:'üí≥', color:'#f87171',
    subcategories:[{id:'sub_cuota',name:'Cuotas'},{id:'sub_tarj',name:'Tarjeta'}] },
  { id:'cat_hormiga',       name:'Gastos Hormiga',   type:'expense', emoji:'üêú', color:'#fb923c',
    subcategories:[{id:'sub_cafe2',name:'Caf√©'},{id:'sub_ci',name:'Cigarrillos'},{id:'sub_misc',name:'Miscel√°neos'}] },
  { id:'cat_educacion',     name:'Educaci√≥n',        type:'expense', emoji:'üìö', color:'#34d399', subcategories:[] },
  { id:'cat_entretenimiento',name:'Entretenimiento', type:'expense', emoji:'üéÆ', color:'#60a5fa',
    subcategories:[{id:'sub_stream',name:'Streaming'},{id:'sub_ocio',name:'Ocio'}] },
  { id:'cat_ropa',          name:'Ropa/Calzado',     type:'expense', emoji:'üëï', color:'#c084fc', subcategories:[] },
  { id:'cat_ahorro',        name:'Ahorro',           type:'expense', emoji:'üê∑', color:'#10b981', subcategories:[] },
  { id:'cat_otros',         name:'Otros',            type:'both',    emoji:'üì¶', color:'#94a3b8', subcategories:[] },
];

// ‚îÄ‚îÄ Datos de ejemplo ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function generateSampleData() {
  const td = Utils.today();
  const tm = td.substring(0,7);
  const lm = Utils.addMonths(td,-1).substring(0,7);
  state.templates = [
    { id:'tpl_sueldo',   type:'income',  amount:4500000, categoryId:'cat_salario',
      note:'Sueldo mensual',     recurrence:{type:'monthly'},       startDate:'2025-01-01', active:true },
    { id:'tpl_alquiler', type:'expense', amount:1800000, categoryId:'cat_alquiler',
      note:'Alquiler',           recurrence:{type:'monthly'},       startDate:'2025-01-05', active:true },
    { id:'tpl_internet', type:'expense', amount:180000,  categoryId:'cat_servicios', subcategoryId:'sub_inter',
      note:'Internet mensual',   recurrence:{type:'monthly'},       startDate:'2025-01-10', active:true },
    { id:'tpl_cafe',     type:'expense', amount:25000,   categoryId:'cat_hormiga',   subcategoryId:'sub_cafe',
      note:'Caf√© del viernes',   recurrence:{type:'special',special:'first_friday'}, startDate:'2025-01-01', active:true },
  ];
  state.transactions = [
    {id:Utils.uuid(),type:'income', amount:4500000,date:`${tm}-01`,categoryId:'cat_salario',  note:'Sueldo febrero',templateId:'tpl_sueldo'},
    {id:Utils.uuid(),type:'expense',amount:1800000,date:`${tm}-05`,categoryId:'cat_alquiler', note:'Alquiler febrero',templateId:'tpl_alquiler'},
    {id:Utils.uuid(),type:'expense',amount:85000,  date:`${tm}-02`,categoryId:'cat_alimentos',subcategoryId:'sub_super',note:'Supermercado Buen D√≠a'},
    {id:Utils.uuid(),type:'expense',amount:45000,  date:`${tm}-03`,categoryId:'cat_transporte',subcategoryId:'sub_comb',note:'Combustible'},
    {id:Utils.uuid(),type:'expense',amount:32000,  date:`${tm}-04`,categoryId:'cat_alimentos',subcategoryId:'sub_rest',note:'Almuerzo con colegas'},
    {id:Utils.uuid(),type:'expense',amount:18000,  date:`${tm}-06`,categoryId:'cat_hormiga',  subcategoryId:'sub_cafe2',note:'Caf√© Havanna'},
    {id:Utils.uuid(),type:'expense',amount:180000, date:`${tm}-10`,categoryId:'cat_servicios',subcategoryId:'sub_inter',note:'Internet'},
    {id:Utils.uuid(),type:'expense',amount:120000, date:`${tm}-08`,categoryId:'cat_salud',    subcategoryId:'sub_med', note:'Farmacia San Pablo'},
    {id:Utils.uuid(),type:'expense',amount:55000,  date:`${tm}-07`,categoryId:'cat_entretenimiento',subcategoryId:'sub_stream',note:'Netflix + Spotify'},
    {id:Utils.uuid(),type:'expense',amount:75000,  date:`${tm}-09`,categoryId:'cat_alimentos',subcategoryId:'sub_super',note:'Supermercado Stock'},
    {id:Utils.uuid(),type:'expense',amount:28000,  date:`${tm}-11`,categoryId:'cat_hormiga',  subcategoryId:'sub_cafe2',note:'Caf√© random'},
    {id:Utils.uuid(),type:'expense',amount:350000, date:`${tm}-12`,categoryId:'cat_deudas',   subcategoryId:'sub_cuota',note:'Cuota pr√©stamo'},
    {id:Utils.uuid(),type:'income', amount:4500000,date:`${lm}-01`,categoryId:'cat_salario',  note:'Sueldo enero'},
    {id:Utils.uuid(),type:'expense',amount:1800000,date:`${lm}-05`,categoryId:'cat_alquiler', note:'Alquiler enero'},
    {id:Utils.uuid(),type:'expense',amount:290000, date:`${lm}-08`,categoryId:'cat_alimentos',subcategoryId:'sub_super',note:'Compras del mes'},
    {id:Utils.uuid(),type:'expense',amount:65000,  date:`${lm}-10`,categoryId:'cat_transporte',subcategoryId:'sub_comb',note:'Combustible'},
    {id:Utils.uuid(),type:'expense',amount:180000, date:`${lm}-10`,categoryId:'cat_servicios',subcategoryId:'sub_inter',note:'Internet'},
    {id:Utils.uuid(),type:'expense',amount:450000, date:`${lm}-15`,categoryId:'cat_ropa',     note:'Ropa temporada'},
    {id:Utils.uuid(),type:'expense',amount:380000, date:`${lm}-20`,categoryId:'cat_deudas',   subcategoryId:'sub_cuota',note:'Cuota pr√©stamo'},
    {id:Utils.uuid(),type:'income', amount:800000, date:`${lm}-25`,categoryId:'cat_freelance',note:'Proyecto web'},
  ];
  state.goals = [
    { id:'goal_1', name:'Salir de deudas', targetAmount:3000000, targetDate:'2026-06-30',
      categoryId:'cat_deudas', isPrimary:true,  notes:'Pagar todos los pr√©stamos pendientes' },
    { id:'goal_2', name:'Fondo de emergencia', targetAmount:5000000, targetDate:'2026-12-31',
      categoryId:'', isPrimary:false, notes:'3 meses de gastos fijos' },
  ];
  state.config.primaryGoalId = 'goal_1';
  state.config.paymentDay = 1;
  saveAll();
}

// ‚îÄ‚îÄ Persistencia ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function saveAll() {
  Utils.save('transactions', state.transactions);
  Utils.save('templates', state.templates);
  Utils.save('categories', state.categories);
  Utils.save('goals', state.goals);
  Utils.save('config', state.config);
}
function loadAll() {
  const tx = Utils.load('transactions');
  if (tx === null) {
    state.categories = JSON.parse(JSON.stringify(DEFAULT_CATEGORIES));
    generateSampleData();
  } else {
    state.transactions = tx || [];
    state.templates    = Utils.load('templates', []);
    state.categories   = Utils.load('categories', JSON.parse(JSON.stringify(DEFAULT_CATEGORIES)));
    state.goals        = Utils.load('goals', []);
    state.config       = { ...state.config, ...Utils.load('config', {}) };
  }
}

// ‚îÄ‚îÄ Tema ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function applyTheme() {
  if (state.config.theme === 'light') {
    document.documentElement.classList.remove('dark');
  } else {
    document.documentElement.classList.add('dark');
  }
}

// ‚îÄ‚îÄ C√°lculos financieros ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function calcBalance(upToDate) {
  const cutoff = upToDate || Utils.today();
  return state.transactions
    .filter(t => t.date <= cutoff)
    .reduce((sum,t) => sum + (t.type==='income' ? t.amount : -t.amount), 0);
}
function calcMonthBalance(yearMonth) {
  const txs = state.transactions.filter(t => t.date.startsWith(yearMonth));
  const income  = Utils.sumBy(txs.filter(t=>t.type==='income'),  t=>t.amount);
  const expense = Utils.sumBy(txs.filter(t=>t.type==='expense'), t=>t.amount);
  return { income, expense, net: income - expense };
}
function getProjectedEvents(fromDate, toDate) {
  const events = [];
  state.templates.filter(t=>t.active).forEach(tpl => {
    const dates = Recurrence.getOccurrencesInRange(tpl, fromDate, toDate);
    dates.forEach(d => events.push({
      date:d, amount:tpl.amount, type:tpl.type, note:tpl.note,
      templateId:tpl.id, categoryId:tpl.categoryId, projected:true
    }));
  });
  return events.sort((a,b) => a.date.localeCompare(b.date));
}
function calcProjectedBalance(upToDate) {
  const today = Utils.today();
  let balance = calcBalance(today);
  state.transactions.filter(t => t.date > today && t.date <= upToDate)
    .forEach(t => { balance += t.type==='income' ? t.amount : -t.amount; });
  getProjectedEvents(Utils.addDays(today,1), upToDate).forEach(e => {
    const realExists = state.transactions.some(t => t.templateId===e.templateId && t.date===e.date);
    if (!realExists) balance += e.type==='income' ? e.amount : -e.amount;
  });
  return balance;
}
function calcEndOfMonthBalance() {
  return calcProjectedBalance(Utils.endOfMonth(Utils.today()));
}
function getPrimaryGoal() {
  return state.goals.find(g => g.id===state.config.primaryGoalId) || state.goals[0] || null;
}
function calcGoalProgress() {
  const goal = getPrimaryGoal();
  if (!goal) return null;
  const today = Utils.today();
  const balance = calcBalance(today);
  const pct = Utils.clamp(Utils.pct(balance, goal.targetAmount), 0, 100);
  const daysLeft = Utils.diffDays(today, goal.targetDate);
  return { goal, balance, pct, daysLeft };
}
function calcDailyBudget() {
  const today = Utils.today();
  const eom = Utils.endOfMonth(today);
  const daysLeft = Utils.diffDays(today, eom) + 1;
  const projBal = calcProjectedBalance(eom);
  const goal = getPrimaryGoal();
  let reserve = 0;
  if (goal && goal.targetDate >= today) {
    const savedToDate = calcBalance(today);
    const needed = Math.max(0, goal.targetAmount - savedToDate);
    const daysToGoal = Math.max(1, Utils.diffDays(today, goal.targetDate));
    reserve = Math.ceil(needed / daysToGoal);
  }
  return Math.max(0, Math.floor((projBal - reserve * daysLeft) / daysLeft));
}

// ‚îÄ‚îÄ Navegaci√≥n ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
const NAV_ITEMS = [
  { id:'dashboard',    emoji:'üìä', label:'Inicio' },
  { id:'transactions', emoji:'üí∏', label:'Movimientos' },
  { id:'templates',    emoji:'üîÑ', label:'Recurrentes' },
  { id:'categories',   emoji:'üè∑Ô∏è', label:'Categor√≠as' },
  { id:'goals',        emoji:'üéØ', label:'Metas' },
  { id:'reports',      emoji:'üìà', label:'Reportes' },
  { id:'settings',     emoji:'‚öôÔ∏è', label:'Config' },
];
const NAV_TITLES = {
  dashboard:'Dashboard', transactions:'Movimientos', templates:'Recurrentes',
  categories:'Categor√≠as', goals:'Metas', reports:'Reportes', settings:'Configuraci√≥n'
};

function buildNav() {
  const sidebarNav = document.getElementById('sidebar-nav');
  const mobileNav  = document.getElementById('mobile-nav');
  if (sidebarNav) sidebarNav.innerHTML = NAV_ITEMS.map(i => `
    <button class="sidebar-nav-item" data-section="${i.id}" onclick="navigate('${i.id}')">
      <span style="font-size:1.1rem">${i.emoji}</span> ${i.label}
    </button>`).join('');
  if (mobileNav) mobileNav.innerHTML = NAV_ITEMS.map(i => `
    <button class="nav-item" data-section="${i.id}" onclick="navigate('${i.id}')">
      <span class="nav-icon">${i.emoji}</span>
      <span>${i.label}</span>
    </button>`).join('');
}

function navigate(section) {
  currentSection = section;
  document.querySelectorAll('.nav-item,.sidebar-nav-item').forEach(el => {
    el.classList.toggle('active', el.dataset.section === section);
  });
  document.querySelectorAll('.app-section').forEach(el => {
    el.style.display = el.id === `section-${section}` ? 'block' : 'none';
  });
  const topbarTitle = document.getElementById('topbar-title');
  if (topbarTitle) topbarTitle.textContent = NAV_TITLES[section] || section;
  renderSection(section);
  if (window.innerWidth < 768) closeSidebar();
}
function renderSection(section) {
  switch(section) {
    case 'dashboard':    renderDashboard();    break;
    case 'transactions': renderTransactions(); break;
    case 'templates':    renderTemplates();    break;
    case 'categories':   renderCategories();   break;
    case 'goals':        renderGoals();        break;
    case 'reports':      renderReports();      break;
    case 'settings':     renderSettings();     break;
  }
}

function openSidebar() {
  document.getElementById('sidebar').classList.add('open');
  document.getElementById('sidebar-overlay').classList.add('active');
  // Add temporary inline open style for mobile
  document.getElementById('sidebar').style.display = 'flex';
}
function closeSidebar() {
  document.getElementById('sidebar').classList.remove('open');
  document.getElementById('sidebar-overlay').classList.remove('active');
  if (window.innerWidth < 768) document.getElementById('sidebar').style.display = '';
}

// ‚îÄ‚îÄ FAB ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function toggleFab() {
  fabOpen = !fabOpen;
  document.getElementById('fab-btn').classList.toggle('open', fabOpen);
  document.getElementById('fab-menu').classList.toggle('open', fabOpen);
  document.getElementById('fab-btn').textContent = fabOpen ? '‚úï' : '+';
}
function closeFab() {
  fabOpen = false;
  document.getElementById('fab-btn').classList.remove('open');
  document.getElementById('fab-menu').classList.remove('open');
  document.getElementById('fab-btn').textContent = '+';
}

// ‚îÄ‚îÄ Helpers de render ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function renderTxItem(t, clickable=true) {
  const cat = state.categories.find(c=>c.id===t.categoryId) || {emoji:'üì¶',name:'Sin categor√≠a',color:'#94a3b8'};
  const isIncome = t.type === 'income';
  return `
    <div class="tx-item" ${clickable?`onclick="openTransactionModal('${t.id}')" style="cursor:pointer"`:''}>
      <div class="tx-icon" style="background:${cat.color}22;color:${cat.color}">${cat.emoji}</div>
      <div style="flex:1;min-width:0">
        <div style="font-size:.875rem;font-weight:600;overflow:hidden;text-overflow:ellipsis;white-space:nowrap">${t.note||cat.name}</div>
        <div style="font-size:.75rem;color:var(--dim)">${cat.name} ¬∑ ${Utils.fmtDateHuman(t.date)}</div>
      </div>
      <div class="mono" style="font-weight:700;color:${isIncome?'#10b981':'#ef4444'};font-size:.9rem;flex-shrink:0">
        ${isIncome?'+':'-'}${Utils.fmtPYG(t.amount)}
      </div>
    </div>`;
}

function renderComparativa(current, previous, label, higherIsBetter=false) {
  if (!previous) return `<div class="stat-card"><div class="label">${label}</div><div style="color:var(--dim);font-size:.8rem">Sin datos anteriores</div></div>`;
  const diff = current - previous;
  const pctDiff = Math.round((diff/previous)*100);
  const isGood = higherIsBetter ? diff>=0 : diff<=0;
  const arrow = diff>0?'‚ñ≤':diff<0?'‚ñº':'‚Äî';
  const color = isGood?'var(--green)':'var(--red)';
  return `
    <div class="stat-card">
      <div class="label">${label} vs mes anterior</div>
      <div class="mono" style="font-size:1rem;font-weight:700">${Utils.fmtPYG(current)}</div>
      <div style="font-size:.8rem;color:${color};margin-top:4px;font-weight:600">
        ${arrow} ${Math.abs(pctDiff)}% (${Utils.fmtPYG(Math.abs(diff))})
      </div>
    </div>`;
}

// ‚îÄ‚îÄ Dashboard ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function renderDashboard() {
  const today = Utils.today();
  const balance = calcBalance(today);
  const eomBalance = calcEndOfMonthBalance();
  const dailyBudget = calcDailyBudget();
  const goalProgress = calcGoalProgress();
  const tm = today.substring(0,7);
  const lm = Utils.addMonths(today,-1).substring(0,7);
  const monthData = calcMonthBalance(tm);
  const lastMonthData = calcMonthBalance(lm);
  const todayTx = state.transactions.filter(t=>t.date===today&&t.type==='expense');
  const todaySpent = Utils.sumBy(todayTx, t=>t.amount);
  const recent = [...state.transactions].sort((a,b)=>b.date.localeCompare(a.date)).slice(0,5);

  let goalHtml = '';
  if (goalProgress) {
    const {goal, balance:bal, pct:progress, daysLeft} = goalProgress;
    const fillClass = `progress-fill${progress>=80?'':progress>=50?' warning':' danger'}`;
    goalHtml = `
      <div class="card" style="margin-bottom:16px">
        <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:12px">
          <div>
            <span class="label">Meta Principal</span>
            <div style="font-size:1rem;font-weight:700">üéØ ${goal.name}</div>
          </div>
          <div style="text-align:right">
            <div style="font-size:.75rem;color:var(--dim)">${daysLeft>0?daysLeft+' d√≠as restantes':'Vencida'}</div>
            <div style="font-size:.8rem;color:var(--muted)">${Utils.fmtDateHuman(goal.targetDate)}</div>
          </div>
        </div>
        <div class="progress-track" style="height:10px;margin-bottom:8px">
          <div class="${fillClass}" style="width:${progress}%"></div>
        </div>
        <div style="display:flex;justify-content:space-between;font-size:.8rem">
          <span style="color:var(--green);font-weight:600">${Utils.fmtPYG(bal)}</span>
          <span style="color:var(--dim)">${progress}% completado</span>
          <span style="color:var(--muted)">${Utils.fmtPYG(goal.targetAmount)}</span>
        </div>
      </div>`;
  }

  document.getElementById('section-dashboard').innerHTML = `
    <div style="padding:20px;max-width:960px;margin:0 auto">
      <div style="display:flex;align-items:flex-start;justify-content:space-between;margin-bottom:20px;gap:12px;flex-wrap:wrap">
        <div>
          <div class="label">Saldo Actual</div>
          <div class="mono" style="font-size:2rem;font-weight:800;color:${balance>=0?'#10b981':'#ef4444'};letter-spacing:-.02em">
            ${Utils.fmtPYG(balance)}
          </div>
          <div style="font-size:.8rem;color:var(--dim)">${Utils.fmtDateFull(today)}</div>
        </div>
        <button class="btn btn-primary" onclick="openGenerarExtraModal()" style="flex-shrink:0">
          üöÄ Generar Extra
        </button>
      </div>

      <div class="stats-grid" style="margin-bottom:16px">
        <div class="stat-card">
          <div class="label">Proyecci√≥n fin de mes</div>
          <div class="mono" style="font-size:1.1rem;font-weight:700;color:${eomBalance>=0?'#10b981':'#ef4444'}">${Utils.fmtPYG(eomBalance)}</div>
          <div style="font-size:.75rem;color:var(--dim)">${Utils.fmtDateHuman(Utils.endOfMonth(today))}</div>
        </div>
        <div class="stat-card">
          <div class="label">Puedo gastar hoy</div>
          <div class="mono" style="font-size:1.1rem;font-weight:700;color:var(--blue)">${Utils.fmtPYG(dailyBudget)}</div>
          <div style="font-size:.75rem;color:var(--dim)">Presupuesto diario recomendado</div>
        </div>
        <div class="stat-card">
          <div class="label">Gast√© hoy</div>
          <div class="mono" style="font-size:1.1rem;font-weight:700;color:${todaySpent>dailyBudget?'#ef4444':'var(--text)'}">${Utils.fmtPYG(todaySpent)}</div>
          <div style="font-size:.75rem;color:${todaySpent>dailyBudget?'#ef4444':'var(--dim)'}">
            ${todaySpent>dailyBudget?'‚ö†Ô∏è Superaste el l√≠mite':'Dentro del presupuesto ‚úì'}
          </div>
        </div>
        <div class="stat-card">
          <div class="label">Ingresos del mes</div>
          <div class="mono" style="font-size:1.1rem;font-weight:700;color:var(--green)">${Utils.fmtPYG(monthData.income)}</div>
          <div style="font-size:.75rem;color:var(--dim)">Gastos: ${Utils.fmtPYG(monthData.expense)}</div>
        </div>
      </div>

      ${goalHtml}

      <div class="two-col" style="margin-bottom:16px">
        <div class="card">
          <div style="font-size:.85rem;font-weight:600;margin-bottom:12px">√öltimos 7 d√≠as</div>
          <div class="chart-container" style="height:160px"><canvas id="chart-7days"></canvas></div>
        </div>
        <div class="card">
          <div style="font-size:.85rem;font-weight:600;margin-bottom:12px">Evoluci√≥n mensual</div>
          <div class="chart-container" style="height:160px"><canvas id="chart-monthly"></canvas></div>
        </div>
      </div>

      <div class="card" style="margin-bottom:16px">
        <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:12px">
          <div style="font-size:.85rem;font-weight:600">√öltimas Transacciones</div>
          <button class="btn btn-ghost btn-sm" onclick="navigate('transactions')">Ver todas ‚Üí</button>
        </div>
        <div>
          ${recent.map(t=>renderTxItem(t)).join('') || '<div class="empty-state"><div class="empty-state-icon">üì≠</div><div class="empty-state-text">Sin transacciones</div></div>'}
        </div>
      </div>

      <div class="card">
        <div style="font-size:.85rem;font-weight:600;margin-bottom:12px">üìä Comparativas</div>
        <div class="two-col">
          ${renderComparativa(monthData.expense, lastMonthData.expense, 'Gastos')}
          ${renderComparativa(monthData.income, lastMonthData.income, 'Ingresos', true)}
        </div>
      </div>
    </div>`;

  setTimeout(() => renderDashboardCharts(), 50);
}

function renderDashboardCharts() {
  const today = Utils.today();
  const ctx1 = document.getElementById('chart-7days');
  if (ctx1) {
    if (charts.days7) charts.days7.destroy();
    const labels=[], incomeData=[], expenseData=[];
    const dayNames = ['Dom','Lun','Mar','Mi√©','Jue','Vie','S√°b'];
    for (let i=6;i>=0;i--) {
      const d = Utils.addDays(today,-i);
      const dt = Utils.parseDate(d);
      labels.push(dayNames[dt.getDay()]);
      const dayTx = state.transactions.filter(t=>t.date===d);
      incomeData.push(Utils.sumBy(dayTx.filter(t=>t.type==='income'),t=>t.amount)/1000);
      expenseData.push(Utils.sumBy(dayTx.filter(t=>t.type==='expense'),t=>t.amount)/1000);
    }
    charts.days7 = new Chart(ctx1, {
      type:'bar', data:{labels, datasets:[
        {label:'Ingresos',data:incomeData,backgroundColor:'rgba(16,185,129,.7)',borderRadius:4},
        {label:'Gastos',  data:expenseData,backgroundColor:'rgba(239,68,68,.7)',borderRadius:4}
      ]},
      options:{responsive:true,maintainAspectRatio:false,
        plugins:{legend:{display:false}},
        scales:{x:{grid:{color:'rgba(255,255,255,.05)'},ticks:{color:'#64748b',font:{size:10}}},
                y:{grid:{color:'rgba(255,255,255,.05)'},ticks:{color:'#64748b',font:{size:10}}}}}
    });
  }
  const ctx2 = document.getElementById('chart-monthly');
  if (ctx2) {
    if (charts.monthly) charts.monthly.destroy();
    const labels=[], balances=[];
    for (let i=5;i>=0;i--) {
      const d = Utils.addMonths(today,-i);
      labels.push(Utils.monthName(d.substring(0,7)+'-01').split(' ')[0]);
      balances.push(calcBalance(Utils.endOfMonth(d.substring(0,7)+'-01'))/1000000);
    }
    charts.monthly = new Chart(ctx2, {
      type:'line', data:{labels, datasets:[{
        label:'Saldo (M‚Ç≤)',data:balances,borderColor:'#3b82f6',
        backgroundColor:'rgba(59,130,246,.1)',fill:true,tension:.4,pointBackgroundColor:'#3b82f6',pointRadius:4
      }]},
      options:{responsive:true,maintainAspectRatio:false,
        plugins:{legend:{display:false}},
        scales:{x:{grid:{color:'rgba(255,255,255,.05)'},ticks:{color:'#64748b',font:{size:10}}},
                y:{grid:{color:'rgba(255,255,255,.05)'},ticks:{color:'#64748b',font:{size:10}}}}}
    });
  }
}

// ‚îÄ‚îÄ Transacciones ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function getFilteredTransactions() {
  return state.transactions.filter(t => {
    if (txFilters.type && t.type!==txFilters.type) return false;
    if (txFilters.categoryId && t.categoryId!==txFilters.categoryId) return false;
    if (txFilters.month && !t.date.startsWith(txFilters.month)) return false;
    if (txFilters.search) {
      const q = txFilters.search.toLowerCase();
      const cat = state.categories.find(c=>c.id===t.categoryId);
      if (!t.note?.toLowerCase().includes(q) && !(cat?.name||'').toLowerCase().includes(q)) return false;
    }
    return true;
  }).sort((a,b)=>b.date.localeCompare(a.date));
}

function renderTransactions() {
  const filtered = getFilteredTransactions();
  const totalPages = Math.ceil(filtered.length / TX_PAGE_SIZE);
  const pageTx = filtered.slice((txPage-1)*TX_PAGE_SIZE, txPage*TX_PAGE_SIZE);
  const months = [...new Set(state.transactions.map(t=>t.date.substring(0,7)))].sort().reverse();

  document.getElementById('section-transactions').innerHTML = `
    <div style="padding:20px;max-width:900px;margin:0 auto">
      <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:16px">
        <div>
          <h2 style="font-size:1.25rem;font-weight:700">Movimientos</h2>
          <div style="font-size:.8rem;color:var(--dim)">${filtered.length} registros</div>
        </div>
        <div style="display:flex;gap:8px">
          <button class="btn btn-success btn-sm" onclick="openTransactionModal(null,'income')">+ Ingreso</button>
          <button class="btn btn-danger btn-sm" onclick="openTransactionModal(null,'expense')">+ Gasto</button>
        </div>
      </div>
      <div class="card" style="margin-bottom:16px;padding:14px">
        <div style="display:flex;gap:8px;flex-wrap:wrap;align-items:center">
          <input type="text" class="input" placeholder="Buscar..." style="width:140px" value="${txFilters.search}"
            oninput="setTxFilter('search',this.value)">
          <select class="input" style="width:120px" onchange="setTxFilter('type',this.value)">
            <option value="" ${!txFilters.type?'selected':''}>Todos</option>
            <option value="income" ${txFilters.type==='income'?'selected':''}>Ingresos</option>
            <option value="expense" ${txFilters.type==='expense'?'selected':''}>Gastos</option>
          </select>
          <select class="input" style="width:150px" onchange="setTxFilter('categoryId',this.value)">
            <option value="">Todas las categ.</option>
            ${state.categories.map(c=>`<option value="${c.id}" ${txFilters.categoryId===c.id?'selected':''}>${c.emoji} ${c.name}</option>`).join('')}
          </select>
          <select class="input" style="width:130px" onchange="setTxFilter('month',this.value)">
            <option value="">Todos los meses</option>
            ${months.map(m=>`<option value="${m}" ${txFilters.month===m?'selected':''}>${Utils.monthName(m+'-01')}</option>`).join('')}
          </select>
          <button class="btn btn-ghost btn-sm" onclick="clearTxFilters()">‚úï Limpiar</button>
        </div>
      </div>
      <div class="three-col" style="margin-bottom:16px">
        <div class="stat-card">
          <div class="label" style="margin-bottom:2px">Ingresos (filtrado)</div>
          <div class="mono" style="color:var(--green);font-weight:700;font-size:.95rem">${Utils.fmtPYG(Utils.sumBy(filtered.filter(t=>t.type==='income'),t=>t.amount))}</div>
        </div>
        <div class="stat-card">
          <div class="label" style="margin-bottom:2px">Gastos (filtrado)</div>
          <div class="mono" style="color:var(--red);font-weight:700;font-size:.95rem">${Utils.fmtPYG(Utils.sumBy(filtered.filter(t=>t.type==='expense'),t=>t.amount))}</div>
        </div>
        <div class="stat-card">
          <div class="label" style="margin-bottom:2px">Neto</div>
          ${(()=>{const net=Utils.sumBy(filtered.filter(t=>t.type==='income'),t=>t.amount)-Utils.sumBy(filtered.filter(t=>t.type==='expense'),t=>t.amount);return`<div class="mono" style="color:${net>=0?'var(--green)':'var(--red)'};font-weight:700;font-size:.95rem">${Utils.fmtPYG(net)}</div>`;})()}
        </div>
      </div>
      <div class="card" style="padding:0;overflow:hidden;margin-bottom:8px">
        ${pageTx.length ? pageTx.map(t=>renderTxItem(t)).join('') :
          '<div class="empty-state"><div class="empty-state-icon">üîç</div><div class="empty-state-title">Sin resultados</div><div class="empty-state-text">Intenta con otros filtros</div></div>'}
      </div>
      ${totalPages>1?`
        <div class="pagination">
          <button class="page-btn" onclick="setTxPage(${txPage-1})" ${txPage===1?'disabled':''}>‚Äπ</button>
          ${Array.from({length:Math.min(totalPages,7)},(_,i)=>`<button class="page-btn ${i+1===txPage?'active':''}" onclick="setTxPage(${i+1})">${i+1}</button>`).join('')}
          <button class="page-btn" onclick="setTxPage(${txPage+1})" ${txPage===totalPages?'disabled':''}>‚Ä∫</button>
        </div>`:''
      }
      <div style="margin-top:12px;text-align:right">
        <button class="btn btn-ghost btn-sm" onclick="exportTransactionsCSV()">‚Üì Exportar CSV</button>
      </div>
    </div>`;
}
function setTxFilter(key,value){txFilters[key]=value;txPage=1;renderTransactions();}
function clearTxFilters(){txFilters={type:'',categoryId:'',search:'',month:''};txPage=1;renderTransactions();}
function setTxPage(p){txPage=Utils.clamp(p,1,Math.ceil(getFilteredTransactions().length/TX_PAGE_SIZE));renderTransactions();}
function exportTransactionsCSV(){
  const rows=getFilteredTransactions().map(t=>{
    const cat=state.categories.find(c=>c.id===t.categoryId);
    const sub=cat?.subcategories?.find(s=>s.id===t.subcategoryId);
    return[t.date,t.type==='income'?'Ingreso':'Gasto',cat?.name||'',sub?.name||'',t.note||'',t.amount];
  });
  Utils.downloadCSV([['Fecha','Tipo','Categor√≠a','Subcategor√≠a','Nota','Monto'],...rows],`efectivo-tx-${Utils.today()}.csv`);
  Utils.toast('CSV exportado ‚úì');
}

// ‚îÄ‚îÄ Modal Transacci√≥n ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function openTransactionModal(id, defaultType='expense') {
  const tx = id ? state.transactions.find(t=>t.id===id) : null;
  const type = tx?.type || defaultType;
  const catOptions = state.categories.filter(c=>c.type===type||c.type==='both')
    .map(c=>`<option value="${c.id}" ${tx?.categoryId===c.id?'selected':''}>${c.emoji} ${c.name}</option>`).join('');
  const selCat = tx ? state.categories.find(c=>c.id===tx.categoryId) : null;
  const subOpts = selCat?.subcategories?.length
    ? selCat.subcategories.map(s=>`<option value="${s.id}" ${tx?.subcategoryId===s.id?'selected':''}>${s.name}</option>`).join('')
    : '';

  openModal({
    title: tx ? 'Editar Transacci√≥n' : (type==='income'?'+ Nuevo Ingreso':'+ Nuevo Gasto'),
    body:`
      <div style="display:flex;flex-direction:column;gap:14px">
        <div>
          <span class="label">Tipo</span>
          <div class="tab-bar" style="max-width:240px">
            <button class="tab-btn ${type==='income'?'active':''}" onclick="switchTxType('income')" id="tab-income">üíö Ingreso</button>
            <button class="tab-btn ${type==='expense'?'active':''}" onclick="switchTxType('expense')" id="tab-expense">‚ù§Ô∏è Gasto</button>
          </div>
          <input type="hidden" id="modal-type" value="${type}">
          <input type="hidden" id="modal-id" value="${id||''}">
        </div>
        <div>
          <span class="label">Monto (‚Ç≤)</span>
          <input type="number" class="input" id="modal-amount" placeholder="0" value="${tx?.amount||''}" min="1" style="font-size:1.2rem;font-weight:700">
        </div>
        <div>
          <span class="label">Fecha</span>
          <input type="date" class="input" id="modal-date" value="${tx?.date||Utils.today()}">
        </div>
        <div>
          <span class="label">Categor√≠a</span>
          <select class="input" id="modal-cat" onchange="updateSubcatOptions()">
            <option value="">Seleccionar categor√≠a</option>${catOptions}
          </select>
        </div>
        <div id="modal-subcat-wrap">
          <span class="label">Subcategor√≠a</span>
          <select class="input" id="modal-subcat">
            <option value="">Sin subcategor√≠a</option>${subOpts}
          </select>
        </div>
        <div>
          <span class="label">Nota</span>
          <input type="text" class="input" id="modal-note" placeholder="Descripci√≥n..." value="${tx?.note||''}">
        </div>
      </div>`,
    footer:`
      ${id?`<button class="btn btn-danger btn-sm" onclick="deleteTransaction('${id}')">üóë Eliminar</button>`:''}
      <div style="flex:1"></div>
      <button class="btn btn-ghost" onclick="closeModal()">Cancelar</button>
      <button class="btn btn-primary" onclick="saveTransaction()">üíæ Guardar</button>`
  });
}
function switchTxType(type) {
  document.getElementById('modal-type').value = type;
  document.getElementById('tab-income').classList.toggle('active', type==='income');
  document.getElementById('tab-expense').classList.toggle('active', type==='expense');
  const catSel = document.getElementById('modal-cat');
  catSel.innerHTML = '<option value="">Seleccionar categor√≠a</option>' +
    state.categories.filter(c=>c.type===type||c.type==='both')
      .map(c=>`<option value="${c.id}">${c.emoji} ${c.name}</option>`).join('');
  updateSubcatOptions();
}
function updateSubcatOptions() {
  const catId = document.getElementById('modal-cat')?.value;
  const cat = state.categories.find(c=>c.id===catId);
  const wrap = document.getElementById('modal-subcat-wrap');
  if (!wrap) return;
  if (cat?.subcategories?.length) {
    wrap.innerHTML = `<span class="label">Subcategor√≠a</span>
      <select class="input" id="modal-subcat">
        <option value="">Sin subcategor√≠a</option>
        ${cat.subcategories.map(s=>`<option value="${s.id}">${s.name}</option>`).join('')}
      </select>`;
  } else {
    wrap.innerHTML = `<span class="label">Subcategor√≠a</span>
      <select class="input" id="modal-subcat"><option value="">Sin subcategor√≠a</option></select>`;
  }
}
function saveTransaction() {
  const id   = document.getElementById('modal-id')?.value;
  const type = document.getElementById('modal-type')?.value;
  const amount = parseInt(document.getElementById('modal-amount')?.value,10);
  const date = document.getElementById('modal-date')?.value;
  const categoryId = document.getElementById('modal-cat')?.value;
  const subcategoryId = document.getElementById('modal-subcat')?.value;
  const note = document.getElementById('modal-note')?.value?.trim();
  if (!amount||amount<=0){Utils.toast('Ingresa un monto v√°lido','error');return;}
  if (!date){Utils.toast('Selecciona una fecha','error');return;}
  if (id) {
    const idx = state.transactions.findIndex(t=>t.id===id);
    if (idx>-1) state.transactions[idx]={...state.transactions[idx],type,amount,date,categoryId,subcategoryId,note};
  } else {
    state.transactions.push({id:Utils.uuid(),type,amount,date,categoryId,subcategoryId,note});
  }
  saveAll(); closeModal();
  Utils.toast(id?'Transacci√≥n actualizada ‚úì':'Transacci√≥n guardada ‚úì');
  renderSection(currentSection);
}
function deleteTransaction(id) {
  if (!confirm('¬øEliminar esta transacci√≥n?')) return;
  state.transactions = state.transactions.filter(t=>t.id!==id);
  saveAll(); closeModal(); Utils.toast('Transacci√≥n eliminada');
  renderSection(currentSection);
}

// ‚îÄ‚îÄ Plantillas ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function renderTemplates() {
  const today = Utils.today();
  const next30 = Utils.addDays(today, 30);
  const upcoming = [];
  state.templates.filter(t=>t.active).forEach(tpl => {
    const dates = Recurrence.getOccurrencesInRange(tpl, today, next30);
    dates.slice(0,3).forEach(d => {
      upcoming.push({tpl, date:d, cat:state.categories.find(c=>c.id===tpl.categoryId)});
    });
  });
  upcoming.sort((a,b)=>a.date.localeCompare(b.date));

  document.getElementById('section-templates').innerHTML = `
    <div style="padding:20px;max-width:900px;margin:0 auto">
      <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:16px">
        <div>
          <h2 style="font-size:1.25rem;font-weight:700">Plantillas Recurrentes</h2>
          <div style="font-size:.8rem;color:var(--dim)">${state.templates.length} plantillas</div>
        </div>
        <button class="btn btn-primary" onclick="openTemplateModal()">+ Nueva</button>
      </div>
      <div class="card" style="margin-bottom:16px;padding:0;overflow:hidden">
        ${state.templates.length ? state.templates.map(tpl => {
          const cat = state.categories.find(c=>c.id===tpl.categoryId);
          return `
            <div class="tx-item" onclick="openTemplateModal('${tpl.id}')" style="cursor:pointer">
              <div class="tx-icon" style="background:${cat?.color||'#94a3b8'}22;color:${cat?.color||'#94a3b8'}">${cat?.emoji||'üì¶'}</div>
              <div style="flex:1;min-width:0">
                <div style="font-size:.875rem;font-weight:600">${tpl.note||cat?.name||'Sin nombre'}</div>
                <div style="font-size:.75rem;color:var(--dim)">${Recurrence.getLabel(tpl.recurrence)} ¬∑ Desde ${Utils.fmtDateHuman(tpl.startDate)}</div>
              </div>
              <div>
                <div class="mono" style="font-weight:700;color:${tpl.type==='income'?'var(--green)':'var(--red)'};font-size:.9rem;text-align:right">
                  ${tpl.type==='income'?'+':'-'}${Utils.fmtPYG(tpl.amount)}
                </div>
                <div style="text-align:right;margin-top:4px">
                  <span class="badge ${tpl.active?'badge-green':'badge-gray'}">${tpl.active?'Activa':'Pausada'}</span>
                </div>
              </div>
            </div>`;
        }).join('') :
          '<div class="empty-state"><div class="empty-state-icon">üîÑ</div><div class="empty-state-title">Sin plantillas</div><div class="empty-state-text">Agrega ingresos y gastos recurrentes</div></div>'
        }
      </div>
      <div class="card">
        <div style="font-size:.85rem;font-weight:600;margin-bottom:14px">üìÖ Pr√≥ximas ocurrencias (30 d√≠as)</div>
        ${upcoming.length ? upcoming.map(({tpl,date,cat})=>`
          <div class="proj-row">
            <div class="proj-date">${Utils.fmtDateHuman(date)}</div>
            <div class="proj-event">
              <span>${cat?.emoji||'üì¶'}</span>${tpl.note||cat?.name||''}
              <span class="badge badge-gray">${Recurrence.getLabel(tpl.recurrence)}</span>
            </div>
            <div class="proj-amount" style="color:${tpl.type==='income'?'var(--green)':'var(--red)'}">
              ${tpl.type==='income'?'+':'-'}${Utils.fmtPYG(tpl.amount)}
            </div>
            <button class="btn btn-ghost btn-xs" onclick="applyTemplateToday('${tpl.id}','${date}')" title="Aplicar como real">‚úì</button>
          </div>`).join('') :
          '<div class="empty-state" style="padding:20px"><div class="empty-state-text">Sin ocurrencias pr√≥ximas</div></div>'
        }
      </div>
    </div>`;
}
function openTemplateModal(id) {
  const tpl = id ? state.templates.find(t=>t.id===id) : null;
  const rec = tpl?.recurrence || {type:'monthly'};
  openModal({
    title: tpl ? 'Editar Plantilla' : '+ Nueva Plantilla',
    body:`
      <div style="display:flex;flex-direction:column;gap:14px">
        <div>
          <span class="label">Tipo</span>
          <div class="tab-bar" style="max-width:240px">
            <button class="tab-btn ${(tpl?.type||'expense')==='income'?'active':''}" id="tpl-tab-income"
              onclick="this.parentNode.querySelectorAll('.tab-btn').forEach(b=>b.classList.remove('active'));this.classList.add('active');document.getElementById('tpl-type').value='income'">üíö Ingreso</button>
            <button class="tab-btn ${(tpl?.type||'expense')==='expense'?'active':''}" id="tpl-tab-expense"
              onclick="this.parentNode.querySelectorAll('.tab-btn').forEach(b=>b.classList.remove('active'));this.classList.add('active');document.getElementById('tpl-type').value='expense'">‚ù§Ô∏è Gasto</button>
          </div>
          <input type="hidden" id="tpl-type" value="${tpl?.type||'expense'}">
          <input type="hidden" id="tpl-id" value="${id||''}">
        </div>
        <div>
          <span class="label">Monto (‚Ç≤)</span>
          <input type="number" class="input" id="tpl-amount" value="${tpl?.amount||''}" min="1" style="font-size:1.1rem;font-weight:700">
        </div>
        <div>
          <span class="label">Categor√≠a</span>
          <select class="input" id="tpl-cat">
            <option value="">Seleccionar...</option>
            ${state.categories.map(c=>`<option value="${c.id}" ${tpl?.categoryId===c.id?'selected':''}>${c.emoji} ${c.name}</option>`).join('')}
          </select>
        </div>
        <div>
          <span class="label">Descripci√≥n</span>
          <input type="text" class="input" id="tpl-note" value="${tpl?.note||''}" placeholder="Ej: Alquiler mensual">
        </div>
        <div>
          <span class="label">Frecuencia</span>
          <select class="input" id="tpl-rectype" onchange="updateRecurrenceFields()">
            <option value="daily"       ${rec.type==='daily'?'selected':''}>Diario</option>
            <option value="every_n_days"${rec.type==='every_n_days'?'selected':''}>Cada N d√≠as</option>
            <option value="weekly"      ${rec.type==='weekly'?'selected':''}>Semanal</option>
            <option value="biweekly"    ${rec.type==='biweekly'?'selected':''}>Quincenal</option>
            <option value="monthly"     ${rec.type==='monthly'?'selected':''}>Mensual (mismo d√≠a)</option>
            <option value="annual"      ${rec.type==='annual'?'selected':''}>Anual</option>
            <option value="special"     ${rec.type==='special'?'selected':''}>Patr√≥n especial...</option>
          </select>
        </div>
        <div id="tpl-rec-extra" style="display:${rec.type==='every_n_days'||rec.type==='special'?'block':'none'}">
          <div id="tpl-n-days" style="display:${rec.type==='every_n_days'?'block':'none'}">
            <span class="label">Cada cu√°ntos d√≠as</span>
            <input type="number" class="input" id="tpl-n" value="${rec.n||2}" min="2" max="365">
          </div>
          <div id="tpl-special-wrap" style="display:${rec.type==='special'?'block':'none'}">
            <span class="label">Patr√≥n especial</span>
            <select class="input" id="tpl-special">
              ${Recurrence.SPECIAL_OPTIONS.map(o=>`<option value="${o.value}" ${rec.special===o.value?'selected':''}>${o.label}</option>`).join('')}
            </select>
          </div>
        </div>
        <div>
          <span class="label">Fecha inicio</span>
          <input type="date" class="input" id="tpl-start" value="${tpl?.startDate||Utils.today()}">
        </div>
        <div>
          <span class="label">Fecha fin (opcional)</span>
          <input type="date" class="input" id="tpl-end" value="${tpl?.endDate||''}">
        </div>
        <label class="toggle" style="gap:10px;cursor:pointer">
          <input type="checkbox" id="tpl-active" ${tpl?.active!==false?'checked':''}>
          <div class="toggle-track"></div><div class="toggle-thumb"></div>
          <span style="font-size:.875rem">Plantilla activa</span>
        </label>
      </div>`,
    footer:`
      ${id?`<button class="btn btn-danger btn-sm" onclick="deleteTemplate('${id}')">üóë Eliminar</button>`:''}
      <div style="flex:1"></div>
      <button class="btn btn-ghost" onclick="closeModal()">Cancelar</button>
      <button class="btn btn-primary" onclick="saveTemplate()">üíæ Guardar</button>`
  });
}
function updateRecurrenceFields() {
  const type = document.getElementById('tpl-rectype')?.value;
  const extra = document.getElementById('tpl-rec-extra');
  const nDays = document.getElementById('tpl-n-days');
  const spWrap = document.getElementById('tpl-special-wrap');
  if (extra) extra.style.display = (type==='every_n_days'||type==='special')?'block':'none';
  if (nDays) nDays.style.display = type==='every_n_days'?'block':'none';
  if (spWrap) spWrap.style.display = type==='special'?'block':'none';
}
function saveTemplate() {
  const id = document.getElementById('tpl-id')?.value;
  const type = document.getElementById('tpl-type')?.value;
  const amount = parseInt(document.getElementById('tpl-amount')?.value,10);
  const categoryId = document.getElementById('tpl-cat')?.value;
  const note = document.getElementById('tpl-note')?.value?.trim();
  const recType = document.getElementById('tpl-rectype')?.value;
  const startDate = document.getElementById('tpl-start')?.value;
  const endDate = document.getElementById('tpl-end')?.value||null;
  const active = document.getElementById('tpl-active')?.checked!==false;
  if (!amount||amount<=0){Utils.toast('Monto inv√°lido','error');return;}
  if (!startDate){Utils.toast('Selecciona fecha de inicio','error');return;}
  const recurrence = {type:recType};
  if (recType==='every_n_days') recurrence.n = parseInt(document.getElementById('tpl-n')?.value,10)||2;
  if (recType==='special') recurrence.special = document.getElementById('tpl-special')?.value;
  const tplData = {type,amount,categoryId,note,recurrence,startDate,endDate,active};
  if (id) { const idx=state.templates.findIndex(t=>t.id===id); if(idx>-1) state.templates[idx]={...state.templates[idx],...tplData}; }
  else state.templates.push({id:Utils.uuid(),...tplData});
  saveAll(); closeModal(); Utils.toast('Plantilla guardada ‚úì'); renderTemplates();
}
function deleteTemplate(id) {
  if (!confirm('¬øEliminar esta plantilla?')) return;
  state.templates = state.templates.filter(t=>t.id!==id);
  saveAll(); closeModal(); Utils.toast('Plantilla eliminada'); renderTemplates();
}
function applyTemplateToday(tplId, date) {
  const tpl = state.templates.find(t=>t.id===tplId);
  if (!tpl) return;
  if (state.transactions.some(t=>t.templateId===tplId&&t.date===date)){Utils.toast('Ya registrada para esa fecha','error');return;}
  state.transactions.push({id:Utils.uuid(),type:tpl.type,amount:tpl.amount,date,categoryId:tpl.categoryId,note:tpl.note,templateId:tplId});
  saveAll(); Utils.toast('Transacci√≥n registrada ‚úì'); renderTemplates();
}

// ‚îÄ‚îÄ Categor√≠as ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
const CAT_COLORS=['#10b981','#3b82f6','#ef4444','#f59e0b','#8b5cf6','#06b6d4','#ec4899','#f97316','#84cc16','#a78bfa','#34d399','#fb923c','#60a5fa','#f472b6','#94a3b8'];
const CAT_EMOJIS=['üíº','üí∞','üõí','üè†','üöå','‚ö°','üè•','üìö','üéÆ','üëï','üí≥','üêú','üìà','üê∑','üì¶','üçΩÔ∏è','‚òï','üöó','‚úàÔ∏è','üéÅ'];

function renderCategories() {
  const exp  = state.categories.filter(c=>c.type==='expense');
  const inc  = state.categories.filter(c=>c.type==='income');
  const both = state.categories.filter(c=>c.type==='both');
  function catList(cats) {
    if (!cats.length) return '<div class="empty-state" style="padding:16px"><div class="empty-state-text">Sin categor√≠as</div></div>';
    return cats.map(cat=>`
      <div class="tx-item" onclick="openCategoryModal('${cat.id}')" style="cursor:pointer">
        <div style="width:36px;height:36px;border-radius:9px;display:flex;align-items:center;justify-content:center;font-size:1.1rem;background:${cat.color}22;flex-shrink:0">${cat.emoji}</div>
        <div style="flex:1">
          <div style="font-size:.875rem;font-weight:600">${cat.name}</div>
          <div style="font-size:.75rem;color:var(--dim)">${cat.subcategories?.length||0} subcategor√≠as ¬∑ ${state.transactions.filter(t=>t.categoryId===cat.id).length} transacciones</div>
        </div>
        <div style="width:12px;height:12px;border-radius:50%;background:${cat.color}"></div>
      </div>`).join('');
  }
  document.getElementById('section-categories').innerHTML = `
    <div style="padding:20px;max-width:800px;margin:0 auto">
      <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:16px">
        <h2 style="font-size:1.25rem;font-weight:700">Categor√≠as</h2>
        <button class="btn btn-primary" onclick="openCategoryModal()">+ Nueva</button>
      </div>
      <div style="display:flex;flex-direction:column;gap:16px">
        <div class="card" style="padding:0;overflow:hidden">
          <div style="padding:12px 16px;border-bottom:1px solid var(--border);font-weight:600;font-size:.85rem;color:var(--green)">üíö Ingresos</div>
          ${catList(inc)}
        </div>
        <div class="card" style="padding:0;overflow:hidden">
          <div style="padding:12px 16px;border-bottom:1px solid var(--border);font-weight:600;font-size:.85rem;color:var(--red)">‚ù§Ô∏è Gastos</div>
          ${catList(exp)}
        </div>
        ${both.length?`<div class="card" style="padding:0;overflow:hidden">
          <div style="padding:12px 16px;border-bottom:1px solid var(--border);font-weight:600;font-size:.85rem;color:var(--muted)">üì¶ Ambos</div>
          ${catList(both)}</div>`:''}
      </div>
    </div>`;
}
function openCategoryModal(id) {
  const cat = id ? state.categories.find(c=>c.id===id) : null;
  openModal({
    title: cat ? 'Editar Categor√≠a' : 'Nueva Categor√≠a',
    body:`
      <div style="display:flex;flex-direction:column;gap:14px">
        <input type="hidden" id="cat-id" value="${id||''}">
        <div>
          <span class="label">Nombre</span>
          <input type="text" class="input" id="cat-name" value="${cat?.name||''}" placeholder="Nombre de categor√≠a">
        </div>
        <div>
          <span class="label">Tipo</span>
          <select class="input" id="cat-type">
            <option value="expense" ${(cat?.type||'expense')==='expense'?'selected':''}>Gasto</option>
            <option value="income"  ${cat?.type==='income'?'selected':''}>Ingreso</option>
            <option value="both"    ${cat?.type==='both'?'selected':''}>Ambos</option>
          </select>
        </div>
        <div>
          <span class="label">Emoji</span>
          <div style="display:flex;gap:5px;flex-wrap:wrap;margin-bottom:8px">
            ${CAT_EMOJIS.map(e=>`<button onclick="document.getElementById('cat-emoji').value='${e}';this.parentNode.querySelectorAll('button').forEach(b=>b.style.outline='');this.style.outline='2px solid var(--blue)'" style="font-size:1.2rem;padding:4px;border-radius:6px;border:none;cursor:pointer;background:${cat?.emoji===e?'var(--surface)':'transparent'};outline:${cat?.emoji===e?'2px solid var(--blue)':'none'}">${e}</button>`).join('')}
          </div>
          <input type="text" class="input" id="cat-emoji" value="${cat?.emoji||'üì¶'}" style="width:80px">
        </div>
        <div>
          <span class="label">Color</span>
          <div style="display:flex;gap:5px;flex-wrap:wrap;margin-bottom:8px">
            ${CAT_COLORS.map(c=>`<div class="color-swatch ${cat?.color===c?'selected':''}" style="background:${c}" onclick="document.getElementById('cat-color').value='${c}';this.parentNode.querySelectorAll('.color-swatch').forEach(s=>s.classList.remove('selected'));this.classList.add('selected')"></div>`).join('')}
          </div>
          <input type="color" id="cat-color" value="${cat?.color||'#94a3b8'}" style="height:36px;width:80px;border-radius:6px;border:none;cursor:pointer">
        </div>
        <div>
          <span class="label">Subcategor√≠as (una por l√≠nea)</span>
          <textarea class="input" id="cat-subs" rows="3" placeholder="Subcategor√≠a 1&#10;Subcategor√≠a 2...">${cat?.subcategories?.map(s=>s.name).join('\n')||''}</textarea>
        </div>
      </div>`,
    footer:`
      ${id?`<button class="btn btn-danger btn-sm" onclick="deleteCategory('${id}')">üóë</button>`:''}
      <div style="flex:1"></div>
      <button class="btn btn-ghost" onclick="closeModal()">Cancelar</button>
      <button class="btn btn-primary" onclick="saveCategory()">Guardar</button>`
  });
}
function saveCategory() {
  const id = document.getElementById('cat-id')?.value;
  const name = document.getElementById('cat-name')?.value?.trim();
  const type = document.getElementById('cat-type')?.value;
  const emoji = document.getElementById('cat-emoji')?.value?.trim()||'üì¶';
  const color = document.getElementById('cat-color')?.value||'#94a3b8';
  const subs = (document.getElementById('cat-subs')?.value||'').split('\n')
    .filter(s=>s.trim()).map(s=>({id:'sub_'+Utils.uuid().substring(0,8),name:s.trim()}));
  if (!name){Utils.toast('Ingresa un nombre','error');return;}
  if (id) { const idx=state.categories.findIndex(c=>c.id===id); if(idx>-1) state.categories[idx]={...state.categories[idx],name,type,emoji,color,subcategories:subs}; }
  else state.categories.push({id:'cat_'+Utils.uuid().substring(0,8),name,type,emoji,color,subcategories:subs});
  saveAll(); closeModal(); Utils.toast('Categor√≠a guardada ‚úì'); renderCategories();
}
function deleteCategory(id) {
  if (state.transactions.some(t=>t.categoryId===id) && !confirm('Esta categor√≠a tiene transacciones. ¬øEliminar?')) return;
  state.categories = state.categories.filter(c=>c.id!==id);
  saveAll(); closeModal(); Utils.toast('Categor√≠a eliminada'); renderCategories();
}

// ‚îÄ‚îÄ Metas ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function renderGoals() {
  const today = Utils.today();
  const currentBalance = calcBalance(today);
  document.getElementById('section-goals').innerHTML = `
    <div style="padding:20px;max-width:800px;margin:0 auto">
      <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:16px">
        <h2 style="font-size:1.25rem;font-weight:700">Metas Financieras</h2>
        <button class="btn btn-primary" onclick="openGoalModal()">+ Nueva Meta</button>
      </div>
      <div style="display:flex;flex-direction:column;gap:16px">
        ${state.goals.length ? state.goals.map(g=>{
          const pct = Utils.clamp(Utils.pct(currentBalance,g.targetAmount),0,100);
          const daysLeft = Utils.diffDays(today,g.targetDate);
          const fillClass = `progress-fill${pct>=80?'':pct>=40?' warning':' danger'}`;
          const remaining = Math.max(0,g.targetAmount-currentBalance);
          const dailyNeeded = daysLeft>0 ? Math.ceil(remaining/daysLeft) : 0;
          return `
            <div class="goal-card ${g.isPrimary?'primary':''}" onclick="openGoalModal('${g.id}')">
              <div style="display:flex;align-items:flex-start;justify-content:space-between;margin-bottom:14px">
                <div>
                  <div style="display:flex;align-items:center;gap:8px;margin-bottom:4px">
                    <span style="font-weight:700">üéØ ${g.name}</span>
                    ${g.isPrimary?'<span class="badge badge-blue">Principal</span>':''}
                  </div>
                  <div style="font-size:.8rem;color:var(--dim)">${g.notes||''}</div>
                </div>
                <div style="text-align:right">
                  <div style="font-size:.75rem;color:var(--dim)">Objetivo</div>
                  <div class="mono" style="font-weight:700;font-size:1rem">${Utils.fmtPYG(g.targetAmount)}</div>
                </div>
              </div>
              <div class="progress-track" style="margin-bottom:8px">
                <div class="${fillClass}" style="width:${pct}%"></div>
              </div>
              <div style="display:flex;justify-content:space-between;font-size:.8rem;margin-bottom:12px">
                <span style="color:var(--green);font-weight:600">${Utils.fmtPYG(currentBalance)}</span>
                <span style="color:var(--dim)">${pct}%</span>
                <span style="color:var(--muted)">${Utils.fmtPYG(g.targetAmount)}</span>
              </div>
              <div class="three-col" style="gap:8px">
                <div style="background:rgba(255,255,255,.04);border-radius:8px;padding:10px;text-align:center">
                  <div style="font-size:.7rem;color:var(--dim)">Falta</div>
                  <div class="mono" style="font-size:.85rem;font-weight:700;color:var(--red)">${Utils.fmtPYG(remaining)}</div>
                </div>
                <div style="background:rgba(255,255,255,.04);border-radius:8px;padding:10px;text-align:center">
                  <div style="font-size:.7rem;color:var(--dim)">D√≠as restantes</div>
                  <div class="mono" style="font-size:.85rem;font-weight:700">${daysLeft}</div>
                </div>
                <div style="background:rgba(255,255,255,.04);border-radius:8px;padding:10px;text-align:center">
                  <div style="font-size:.7rem;color:var(--dim)">Ahorrar/d√≠a</div>
                  <div class="mono" style="font-size:.85rem;font-weight:700;color:var(--blue)">${Utils.fmtPYG(dailyNeeded)}</div>
                </div>
              </div>
              <div style="font-size:.75rem;color:var(--dim);margin-top:10px;text-align:right">Fecha objetivo: ${Utils.fmtDateHuman(g.targetDate)}</div>
            </div>`;
        }).join('') :
          '<div class="empty-state"><div class="empty-state-icon">üéØ</div><div class="empty-state-title">Sin metas</div><div class="empty-state-text">Define tus objetivos financieros</div></div>'
        }
      </div>
    </div>`;
}
function openGoalModal(id) {
  const goal = id ? state.goals.find(g=>g.id===id) : null;
  openModal({
    title: goal ? 'Editar Meta' : 'Nueva Meta Financiera',
    body:`
      <div style="display:flex;flex-direction:column;gap:14px">
        <input type="hidden" id="goal-id" value="${id||''}">
        <div><span class="label">Nombre de la meta</span>
          <input type="text" class="input" id="goal-name" value="${goal?.name||''}" placeholder="Ej: Salir de deudas"></div>
        <div><span class="label">Monto objetivo (‚Ç≤)</span>
          <input type="number" class="input" id="goal-amount" value="${goal?.targetAmount||''}" min="1" style="font-size:1.1rem;font-weight:700"></div>
        <div><span class="label">Fecha objetivo</span>
          <input type="date" class="input" id="goal-date" value="${goal?.targetDate||''}"></div>
        <div><span class="label">Notas</span>
          <textarea class="input" id="goal-notes" rows="2" placeholder="Descripci√≥n...">${goal?.notes||''}</textarea></div>
        <label class="toggle" style="gap:10px;cursor:pointer">
          <input type="checkbox" id="goal-primary" ${goal?.isPrimary?'checked':''}>
          <div class="toggle-track"></div><div class="toggle-thumb"></div>
          <span style="font-size:.875rem">Meta principal (usada en el Dashboard)</span>
        </label>
      </div>`,
    footer:`
      ${id?`<button class="btn btn-danger btn-sm" onclick="deleteGoal('${id}')">üóë Eliminar</button>`:''}
      <div style="flex:1"></div>
      <button class="btn btn-ghost" onclick="closeModal()">Cancelar</button>
      <button class="btn btn-primary" onclick="saveGoal()">üíæ Guardar</button>`
  });
}
function saveGoal() {
  const id = document.getElementById('goal-id')?.value;
  const name = document.getElementById('goal-name')?.value?.trim();
  const targetAmount = parseInt(document.getElementById('goal-amount')?.value,10);
  const targetDate = document.getElementById('goal-date')?.value;
  const notes = document.getElementById('goal-notes')?.value?.trim();
  const isPrimary = document.getElementById('goal-primary')?.checked;
  if (!name){Utils.toast('Ingresa un nombre','error');return;}
  if (!targetAmount||targetAmount<=0){Utils.toast('Monto inv√°lido','error');return;}
  if (!targetDate){Utils.toast('Selecciona una fecha','error');return;}
  if (isPrimary) state.goals.forEach(g=>g.isPrimary=false);
  if (id) { const idx=state.goals.findIndex(g=>g.id===id); if(idx>-1) state.goals[idx]={...state.goals[idx],name,targetAmount,targetDate,notes,isPrimary}; }
  else { const ng={id:Utils.uuid(),name,targetAmount,targetDate,notes,isPrimary}; state.goals.push(ng); if(isPrimary) state.config.primaryGoalId=ng.id; }
  if (isPrimary) state.config.primaryGoalId = id || state.goals[state.goals.length-1].id;
  saveAll(); closeModal(); Utils.toast('Meta guardada ‚úì'); renderGoals();
}
function deleteGoal(id) {
  if (!confirm('¬øEliminar esta meta?')) return;
  state.goals = state.goals.filter(g=>g.id!==id);
  if (state.config.primaryGoalId===id) state.config.primaryGoalId=state.goals[0]?.id||null;
  saveAll(); closeModal(); Utils.toast('Meta eliminada'); renderGoals();
}

// ‚îÄ‚îÄ Reportes ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function renderReports() {
  const today = Utils.today();
  const tm = today.substring(0,7);
  const lm = Utils.addMonths(today,-1).substring(0,7);
  const thisMonthExp = state.transactions.filter(t=>t.date.startsWith(tm)&&t.type==='expense');
  const sortedSmall = [...state.transactions].filter(t=>t.type==='expense'&&t.date.startsWith(tm)).sort((a,b)=>a.amount-b.amount).slice(0,10);
  const dayOfMonth = parseInt(today.split('-')[2],10);
  const thisTxAll = state.transactions.filter(t=>t.date.startsWith(tm));
  const thisInc = Utils.sumBy(thisTxAll.filter(t=>t.type==='income'),t=>t.amount);
  const thisExp = Utils.sumBy(thisTxAll.filter(t=>t.type==='expense'),t=>t.amount);
  const dailyAvg = dayOfMonth>0?Math.round(thisExp/dayOfMonth):0;
  const weeklyAvg = Math.round(thisExp/Math.max(1,Math.ceil(dayOfMonth/7)));

  document.getElementById('section-reports').innerHTML = `
    <div style="padding:20px;max-width:960px;margin:0 auto">
      <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:16px">
        <h2 style="font-size:1.25rem;font-weight:700">Reportes</h2>
        <button class="btn btn-ghost btn-sm" onclick="exportReportCSV()">‚Üì Exportar CSV</button>
      </div>
      <div class="stats-grid" style="margin-bottom:16px">
        <div class="stat-card"><div class="label">Ingresos este mes</div><div class="mono" style="color:var(--green);font-weight:700;font-size:1rem">${Utils.fmtPYG(thisInc)}</div></div>
        <div class="stat-card"><div class="label">Gastos este mes</div><div class="mono" style="color:var(--red);font-weight:700;font-size:1rem">${Utils.fmtPYG(thisExp)}</div></div>
        <div class="stat-card"><div class="label">Gasto diario prom.</div><div class="mono" style="color:var(--yellow);font-weight:700;font-size:1rem">${Utils.fmtPYG(dailyAvg)}</div></div>
        <div class="stat-card"><div class="label">Gasto semanal prom.</div><div class="mono" style="font-weight:700;font-size:1rem">${Utils.fmtPYG(weeklyAvg)}</div></div>
      </div>
      <div class="two-col" style="margin-bottom:16px">
        <div class="card">
          <div style="font-size:.85rem;font-weight:600;margin-bottom:12px">Gastos por categor√≠a este mes</div>
          <div class="chart-container" style="height:220px;display:flex;align-items:center;justify-content:center">
            <canvas id="chart-pie"></canvas>
          </div>
          <div id="pie-legend" style="margin-top:12px;display:flex;flex-direction:column;gap:5px"></div>
        </div>
        <div class="card">
          <div style="font-size:.85rem;font-weight:600;margin-bottom:12px">Evoluci√≥n √∫ltimos 6 meses</div>
          <div class="chart-container" style="height:220px"><canvas id="chart-evo"></canvas></div>
        </div>
      </div>
      <div class="card" style="margin-bottom:16px">
        <div style="font-size:.85rem;font-weight:600;margin-bottom:12px">üêú Top 10 gastos peque√±os del mes</div>
        ${sortedSmall.length ? sortedSmall.map((t,i)=>{
          const cat=state.categories.find(c=>c.id===t.categoryId);
          return `
            <div style="display:flex;align-items:center;gap:10px;padding:8px 0;border-bottom:1px solid rgba(255,255,255,.04)">
              <div style="width:22px;text-align:center;font-size:.75rem;color:var(--dim);font-weight:700">#${i+1}</div>
              <div style="font-size:1rem">${cat?.emoji||'üì¶'}</div>
              <div style="flex:1;font-size:.875rem">${t.note||cat?.name||'Sin nota'}</div>
              <div style="font-size:.75rem;color:var(--dim)">${Utils.fmtDateHuman(t.date)}</div>
              <div class="mono" style="color:var(--red);font-weight:700;font-size:.875rem">${Utils.fmtPYG(t.amount)}</div>
            </div>`;
        }).join('') : '<div class="empty-state" style="padding:20px"><div class="empty-state-text">Sin gastos este mes</div></div>'}
      </div>
      <div class="card">
        <div style="font-size:.85rem;font-weight:600;margin-bottom:12px">üìÖ Proyecci√≥n pr√≥ximos 30 d√≠as</div>
        <div id="projection-table">${renderProjectionTable()}</div>
      </div>
    </div>`;
  setTimeout(()=>renderReportCharts(), 50);
}

function renderProjectionTable() {
  const today = Utils.today();
  const end30 = Utils.addDays(today, 30);
  const events = [];
  state.transactions.filter(t=>t.date>today&&t.date<=end30).forEach(t=>{
    const cat=state.categories.find(c=>c.id===t.categoryId);
    events.push({date:t.date,label:t.note||cat?.name||'',amount:t.amount,type:t.type,projected:false});
  });
  getProjectedEvents(Utils.addDays(today,1),end30).forEach(e=>{
    const realExists=state.transactions.some(t=>t.templateId===e.templateId&&t.date===e.date);
    if (!realExists){const cat=state.categories.find(c=>c.id===e.categoryId);events.push({date:e.date,label:e.note||cat?.name||'',amount:e.amount,type:e.type,projected:true});}
  });
  events.sort((a,b)=>a.date.localeCompare(b.date));
  if (!events.length) return '<div class="empty-state" style="padding:20px"><div class="empty-state-text">Agrega plantillas recurrentes para ver proyecciones</div></div>';
  let runBalance = calcBalance(today);
  return events.map(e=>{
    runBalance += e.type==='income'?e.amount:-e.amount;
    return `
      <div class="proj-row">
        <div class="proj-date">${Utils.fmtDateHuman(e.date)}</div>
        <div class="proj-event">${e.label}${e.projected?'<span class="badge badge-gray" style="font-size:.65rem">proy.</span>':''}</div>
        <div class="proj-amount" style="color:${e.type==='income'?'var(--green)':'var(--red)'}">${e.type==='income'?'+':'-'}${Utils.fmtPYG(e.amount)}</div>
        <div class="proj-balance" style="color:${runBalance>=0?'var(--green)':'var(--red)'}">${Utils.fmtPYG(runBalance)}</div>
      </div>`;
  }).join('');
}

function renderReportCharts() {
  const today = Utils.today();
  const tm = today.substring(0,7);
  const expTx = state.transactions.filter(t=>t.date.startsWith(tm)&&t.type==='expense');
  const grouped = Utils.groupBy(expTx, t=>t.categoryId);
  const ctx1 = document.getElementById('chart-pie');
  if (ctx1) {
    if (charts.pie) charts.pie.destroy();
    const labels=[],data=[],colors=[],legendItems=[];
    Object.entries(grouped).forEach(([catId,txs])=>{
      const cat=state.categories.find(c=>c.id===catId)||{name:'Otros',color:'#94a3b8',emoji:'üì¶'};
      const total=Utils.sumBy(txs,t=>t.amount);
      labels.push(cat.name); data.push(total); colors.push(cat.color);
      legendItems.push({name:cat.name,color:cat.color,total});
    });
    if (data.length) {
      charts.pie = new Chart(ctx1, {
        type:'doughnut',
        data:{labels,datasets:[{data,backgroundColor:colors,borderWidth:2,borderColor:'var(--surface)'}]},
        options:{responsive:true,maintainAspectRatio:false,plugins:{legend:{display:false}}}
      });
      const legend=document.getElementById('pie-legend');
      if (legend) legend.innerHTML=legendItems.sort((a,b)=>b.total-a.total).slice(0,6).map(item=>`
        <div style="display:flex;align-items:center;justify-content:space-between;gap:8px;font-size:.8rem">
          <div style="display:flex;align-items:center;gap:6px">
            <div style="width:8px;height:8px;border-radius:50%;background:${item.color};flex-shrink:0"></div>
            <span style="color:var(--muted)">${item.name}</span>
          </div>
          <span class="mono" style="font-weight:600">${Utils.fmtPYG(item.total)}</span>
        </div>`).join('');
    }
  }
  const ctx2 = document.getElementById('chart-evo');
  if (ctx2) {
    if (charts.evo) charts.evo.destroy();
    const labels=[],incomeData=[],expData=[];
    for (let i=5;i>=0;i--) {
      const d=Utils.addMonths(today,-i);
      const ym=d.substring(0,7);
      const m=calcMonthBalance(ym);
      labels.push(Utils.monthName(ym+'-01').split(' ')[0]);
      incomeData.push(m.income/1000000); expData.push(m.expense/1000000);
    }
    charts.evo = new Chart(ctx2, {
      type:'line',
      data:{labels,datasets:[
        {label:'Ingresos',data:incomeData,borderColor:'#10b981',backgroundColor:'rgba(16,185,129,.08)',fill:true,tension:.4,pointRadius:4},
        {label:'Gastos',  data:expData,  borderColor:'#ef4444',backgroundColor:'rgba(239,68,68,.08)',  fill:true,tension:.4,pointRadius:4}
      ]},
      options:{responsive:true,maintainAspectRatio:false,
        plugins:{legend:{position:'bottom',labels:{color:'#64748b',font:{size:10},boxWidth:12}}},
        scales:{x:{grid:{color:'rgba(255,255,255,.05)'},ticks:{color:'#64748b',font:{size:10}}},
                y:{grid:{color:'rgba(255,255,255,.05)'},ticks:{color:'#64748b',font:{size:10}}}}}
    });
  }
}
function exportReportCSV() {
  const today = Utils.today();
  const tm = today.substring(0,7);
  const rows = state.transactions.filter(t=>t.date.startsWith(tm)).map(t=>{
    const cat=state.categories.find(c=>c.id===t.categoryId);
    const sub=cat?.subcategories?.find(s=>s.id===t.subcategoryId);
    return[t.date,t.type==='income'?'Ingreso':'Gasto',cat?.name||'',sub?.name||'',t.note||'',t.amount];
  });
  Utils.downloadCSV([['Fecha','Tipo','Categor√≠a','Subcategor√≠a','Nota','Monto'],...rows],`efectivo-reporte-${tm}.csv`);
  Utils.toast('Reporte exportado ‚úì');
}

// ‚îÄ‚îÄ Modal Generar Extra ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function openGenerarExtraModal() {
  const today = Utils.today();
  const balance = calcBalance(today);
  const goal = getPrimaryGoal();
  if (!goal){Utils.toast('Define una meta principal primero','error');navigate('goals');return;}
  const remaining = Math.max(0,goal.targetAmount-balance);
  const daysLeft = Utils.diffDays(today,goal.targetDate);
  const eom = Utils.endOfMonth(today);
  const daysToEom = Utils.diffDays(today,eom);
  const extraMonth = daysLeft>0 ? Math.ceil(remaining/Math.max(1,Math.ceil(daysLeft/30))) : remaining;
  const dailyRed = daysToEom>0 ? Math.ceil(extraMonth/daysToEom) : 0;
  const dailyBudget = calcDailyBudget();
  openModal({
    title:'üöÄ Calculadora de Extras',
    body:`
      <div style="display:flex;flex-direction:column;gap:16px">
        <div class="highlight-banner">
          <div style="font-size:.85rem;color:var(--muted);margin-bottom:4px">Meta: ${goal.name}</div>
          <div class="mono" style="font-size:1.5rem;font-weight:800;color:var(--blue)">${Utils.fmtPYG(remaining)} <span style="font-size:.9rem;font-weight:400;color:var(--dim)">faltantes</span></div>
          <div style="font-size:.8rem;color:var(--dim);margin-top:4px">${daysLeft} d√≠as para ${Utils.fmtDateHuman(goal.targetDate)}</div>
        </div>
        <div style="background:rgba(255,255,255,.04);border-radius:var(--radius-sm);padding:16px">
          <div style="font-size:.85rem;font-weight:600;margin-bottom:12px;color:var(--green)">üí° Opciones para lograrlo:</div>
          <div style="display:flex;flex-direction:column;gap:10px">
            <div style="padding:12px;background:var(--surface);border-radius:8px;border-left:3px solid var(--green)">
              <div style="font-size:.8rem;color:var(--dim)">Opci√≥n 1: Generar ingresos extra</div>
              <div class="mono" style="font-size:1.1rem;font-weight:700;color:var(--green);margin-top:4px">${Utils.fmtPYG(extraMonth)} este mes</div>
              <div style="font-size:.75rem;color:var(--dim);margin-top:2px">= ${Utils.fmtPYG(Math.ceil(extraMonth/30))}/d√≠a</div>
            </div>
            <div style="padding:12px;background:var(--surface);border-radius:8px;border-left:3px solid var(--yellow)">
              <div style="font-size:.8rem;color:var(--dim)">Opci√≥n 2: Reducir gastos diarios</div>
              <div class="mono" style="font-size:1.1rem;font-weight:700;color:var(--yellow);margin-top:4px">${Utils.fmtPYG(dailyRed)} menos por d√≠a</div>
              <div style="font-size:.75rem;color:var(--dim);margin-top:2px">Presupuesto actual: ${Utils.fmtPYG(dailyBudget)}/d√≠a</div>
            </div>
            <div style="padding:12px;background:var(--surface);border-radius:8px;border-left:3px solid var(--blue)">
              <div style="font-size:.8rem;color:var(--dim)">Opci√≥n 3: Combinado 50/50</div>
              <div class="mono" style="font-size:1.1rem;font-weight:700;color:var(--blue);margin-top:4px">
                +${Utils.fmtPYG(Math.ceil(extraMonth/2))} extra + ahorrar ${Utils.fmtPYG(Math.ceil(dailyRed/2))}/d√≠a
              </div>
            </div>
          </div>
        </div>
        <div style="font-size:.8rem;color:var(--dim);text-align:center">üí° Registra tus ingresos extras al recibirlos para actualizar el progreso</div>
      </div>`,
    footer:`
      <button class="btn btn-ghost" onclick="closeModal()">Cerrar</button>
      <button class="btn btn-success" onclick="closeModal();openTransactionModal(null,'income')">+ Registrar ingreso extra</button>`
  });
}

// ‚îÄ‚îÄ Configuraci√≥n ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function renderSettings() {
  document.getElementById('section-settings').innerHTML = `
    <div style="padding:20px;max-width:700px;margin:0 auto">
      <h2 style="font-size:1.25rem;font-weight:700;margin-bottom:20px">‚öôÔ∏è Configuraci√≥n</h2>
      <div class="card" style="margin-bottom:16px">
        <div style="font-size:.85rem;font-weight:600;margin-bottom:14px">Preferencias</div>
        <div style="display:flex;flex-direction:column;gap:14px">
          <div style="display:flex;align-items:center;justify-content:space-between">
            <div><div style="font-weight:500;font-size:.875rem">Modo oscuro</div><div style="font-size:.75rem;color:var(--dim)">Tema de la aplicaci√≥n</div></div>
            <label class="toggle"><input type="checkbox" id="toggle-dark" ${state.config.theme==='dark'?'checked':''} onchange="toggleTheme()">
              <div class="toggle-track"></div><div class="toggle-thumb"></div></label>
          </div>
          <div style="display:flex;align-items:center;justify-content:space-between">
            <div><div style="font-weight:500;font-size:.875rem">D√≠a de cobro</div><div style="font-size:.75rem;color:var(--dim)">D√≠a del mes en que recibes tu sueldo</div></div>
            <select class="input" style="width:80px" onchange="setPaymentDay(this.value)">
              ${Array.from({length:31},(_,i)=>`<option value="${i+1}" ${state.config.paymentDay===i+1?'selected':''}>${i+1}</option>`).join('')}
            </select>
          </div>
          <div style="display:flex;align-items:center;justify-content:space-between">
            <div><div style="font-weight:500;font-size:.875rem">Meta principal</div><div style="font-size:.75rem;color:var(--dim)">Usada en el dashboard</div></div>
            <select class="input" style="width:180px" onchange="setPrimaryGoal(this.value)">
              <option value="">Sin meta principal</option>
              ${state.goals.map(g=>`<option value="${g.id}" ${state.config.primaryGoalId===g.id?'selected':''}>${g.name}</option>`).join('')}
            </select>
          </div>
        </div>
      </div>
      <div class="card" style="margin-bottom:16px">
        <div style="font-size:.85rem;font-weight:600;margin-bottom:14px">Gesti√≥n de Datos</div>
        <div style="display:flex;flex-direction:column;gap:10px">
          <div style="display:flex;align-items:center;justify-content:space-between;padding:12px;background:rgba(255,255,255,.04);border-radius:8px">
            <div><div style="font-weight:500;font-size:.875rem">Exportar todos los datos</div><div style="font-size:.75rem;color:var(--dim)">Descarga un JSON con toda la informaci√≥n</div></div>
            <button class="btn btn-ghost btn-sm" onclick="exportData()">‚Üì JSON</button>
          </div>
          <div style="display:flex;align-items:center;justify-content:space-between;padding:12px;background:rgba(255,255,255,.04);border-radius:8px">
            <div><div style="font-weight:500;font-size:.875rem">Importar datos</div><div style="font-size:.75rem;color:var(--dim)">Carga un JSON exportado anteriormente</div></div>
            <label class="btn btn-ghost btn-sm" style="cursor:pointer">‚Üë JSON<input type="file" accept=".json" style="display:none" onchange="importData(event)"></label>
          </div>
        </div>
      </div>
      <div class="card" style="margin-bottom:16px">
        <div style="font-size:.85rem;font-weight:600;margin-bottom:14px">üìä Resumen</div>
        <div class="three-col">
          <div style="text-align:center;padding:12px;background:rgba(255,255,255,.04);border-radius:8px">
            <div class="mono" style="font-size:1.5rem;font-weight:700;color:var(--blue)">${state.transactions.length}</div>
            <div style="font-size:.75rem;color:var(--dim)">Transacciones</div>
          </div>
          <div style="text-align:center;padding:12px;background:rgba(255,255,255,.04);border-radius:8px">
            <div class="mono" style="font-size:1.5rem;font-weight:700;color:var(--purple)">${state.templates.length}</div>
            <div style="font-size:.75rem;color:var(--dim)">Plantillas</div>
          </div>
          <div style="text-align:center;padding:12px;background:rgba(255,255,255,.04);border-radius:8px">
            <div class="mono" style="font-size:1.5rem;font-weight:700;color:var(--green)">${state.goals.length}</div>
            <div style="font-size:.75rem;color:var(--dim)">Metas</div>
          </div>
        </div>
      </div>
      <div class="card" style="border-color:rgba(239,68,68,.25)">
        <div style="font-size:.85rem;font-weight:600;color:var(--red);margin-bottom:12px">‚ö†Ô∏è Zona Peligrosa</div>
        <div style="display:flex;align-items:center;justify-content:space-between;padding:12px;background:rgba(239,68,68,.05);border-radius:8px">
          <div><div style="font-weight:500;font-size:.875rem">Resetear aplicaci√≥n</div><div style="font-size:.75rem;color:var(--dim)">Elimina TODOS los datos permanentemente</div></div>
          <button class="btn btn-danger btn-sm" onclick="resetApp()">üóëÔ∏è Resetear</button>
        </div>
      </div>
      <div style="text-align:center;margin-top:24px;color:var(--dim);font-size:.75rem">
        <div>üí∞ EFECTIVO v${state.config.version}</div>
        <div style="margin-top:4px">Control total de finanzas en Paraguay ‚Ä¢ Hecho con ‚ù§Ô∏è</div>
      </div>
    </div>`;
}
function toggleTheme() {
  state.config.theme = document.getElementById('toggle-dark').checked ? 'dark' : 'light';
  applyTheme(); saveAll();
}
function setPaymentDay(val){state.config.paymentDay=parseInt(val,10);saveAll();Utils.toast('D√≠a de cobro actualizado ‚úì');}
function setPrimaryGoal(id){
  state.config.primaryGoalId=id||null;
  if(id) state.goals.forEach(g=>g.isPrimary=g.id===id);
  saveAll(); Utils.toast('Meta principal actualizada ‚úì');
}
function exportData(){Utils.downloadJSON(Utils.exportAll(),`efectivo-backup-${Utils.today()}.json`);Utils.toast('Datos exportados ‚úì');}
function importData(event) {
  const file=event.target.files[0]; if (!file) return;
  const reader=new FileReader();
  reader.onload=(e)=>{
    try {
      const data=JSON.parse(e.target.result);
      if(!confirm('¬øImportar datos? Esto reemplazar√° tu informaci√≥n actual.')) return;
      Utils.importAll(data); loadAll(); applyTheme(); Utils.toast('Datos importados ‚úì'); navigate('dashboard');
    } catch(err){Utils.toast('Error al importar el archivo','error');}
  };
  reader.readAsText(file);
}
function resetApp(){
  if(!confirm('‚ö†Ô∏è ¬øSeguro? Se eliminar√°n TODOS los datos.')||!confirm('Confirma que quieres borrar todo.')) return;
  Utils.clearAll(); location.reload();
}

// ‚îÄ‚îÄ Sistema de modales ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function openModal({title,body,footer}) {
  const overlay = document.getElementById('modal-overlay');
  const content = document.getElementById('modal-content');
  if (!overlay||!content) return;
  content.innerHTML = `
    <div class="modal-header">
      <div style="font-size:1rem;font-weight:700">${title}</div>
      <button class="modal-close" onclick="closeModal()">‚úï</button>
    </div>
    <div class="modal-body">${body}</div>
    <div class="modal-footer">${footer}</div>`;
  overlay.style.display = 'flex';
  document.body.style.overflow = 'hidden';
  requestAnimationFrame(()=>requestAnimationFrame(()=>content.classList.add('modal-show')));
}
function closeModal() {
  const overlay = document.getElementById('modal-overlay');
  const content = document.getElementById('modal-content');
  if (!overlay||!content) return;
  content.classList.remove('modal-show');
  setTimeout(()=>{ overlay.style.display='none'; document.body.style.overflow=''; content.innerHTML=''; }, 300);
}

// ‚îÄ‚îÄ Inicializaci√≥n ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function init() {
  loadAll();
  applyTheme();
  buildNav();
  navigate('dashboard');

  // Ocultar splash
  document.getElementById('loading').style.display = 'none';
  document.getElementById('app').style.display = 'block';

  // Sidebar overlay cierra al hacer clic
  document.getElementById('sidebar-overlay').addEventListener('click', closeSidebar);

  // Modal cierra al hacer clic fuera
  document.getElementById('modal-overlay').addEventListener('click', e=>{
    if (e.target.id==='modal-overlay') closeModal();
  });

  // FAB
  document.getElementById('fab-btn').addEventListener('click', e=>{e.stopPropagation();toggleFab();});
  document.getElementById('fab-income').addEventListener('click', ()=>{closeFab();openTransactionModal(null,'income');});
  document.getElementById('fab-expense').addEventListener('click', ()=>{closeFab();openTransactionModal(null,'expense');});
  document.addEventListener('click', e=>{
    if(fabOpen && !e.target.closest('#fab-btn') && !e.target.closest('#fab-menu')) closeFab();
  });

  // Tecla Escape cierra modal
  document.addEventListener('keydown', e=>{if(e.key==='Escape'){closeModal();closeFab();}});
}

document.addEventListener('DOMContentLoaded', init);
</script>
</body>
</html>